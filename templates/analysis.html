<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã - CryptoAnalyst Pro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tradingview.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/inline-styles.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìà</text></svg>">

</head>
{%include '_lang_header.html'%}

    <div class="container">
        <header>
            {% include '_header.html' %}
        </header>

        <main>
            <!-- Page Header -->
            <div class="page-header">
                <div class="header-content">
                    <h2 id="symbol-header">–ê–Ω–∞–ª–∏–∑ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã</h2>
                    <div class="header-actions">
                        <span class="update-time" id="update-time">
                            <i class="fas fa-clock"></i> –û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="update-timestamp">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </span>
                        <button class="btn btn-primary" id="refresh-analysis">
                            <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>

            <!-- Price Header -->
            <section class="price-header">
                <div class="price-info">
                    <h3 id="current-symbol">{{ symbol }}</h3>
                    <div class="price-large" id="current-price">${{ "%.2f"|format(current_price) if current_price else "0.00" }}</div>
                    <div class="price-change {% if price_change >= 0 %}positive{% else %}negative{% endif %}"
                         id="price-change">
                        <i class="fas fa-arrow-{% if price_change >= 0 %}up{% else %}down{% endif %}"></i>
                        {{ "%.2f"|format(price_change|abs) }}%
                    </div>
                </div>
            </section>

            <!-- TradingView Chart -->
            <section class="chart-section">
                <div class="tradingview-widget-container">
                    <div id="tradingview-chart"></div>
                    <div class="tradingview-widget-copyright">
                        <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                            <span class="blue-text">Track –≤—Å–µ —Ä—ã–Ω–∫–∏ –Ω–∞ TradingView</span>
                        </a>
                    </div>
                </div>

                <!-- Timeframe Controls -->
                <div class="timeframe-controls">
                    <h4><i class="fas fa-chart-line"></i> –¢–∞–π–º—Ñ—Ä–µ–π–º –∞–Ω–∞–ª–∏–∑–∞</h4>
                    <div class="timeframe-buttons">
                        <button class="btn" data-tf="1">1M</button>
                        <button class="btn" data-tf="5">5M</button>
                        <button class="btn" data-tf="15">15M</button>
                        <button class="btn" data-tf="30">30M</button>
                        <button class="btn active" data-tf="60">1H</button>
                        <button class="btn" data-tf="240">4H</button>
                        <button class="btn" data-tf="D">1D</button>
                        <button class="btn" data-tf="W">1W</button>
                    </div>
                </div>
            </section>

            <!-- Auto Refresh Section -->
            <section class="auto-refresh-section">
                <div class="refresh-controls">
                    <h4><i class="fas fa-sync-alt"></i> –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h4>
                    <div class="refresh-status">
                        <span class="live-indicator"></span>
                        <span>–°–ª–µ–¥—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑: <span id="countdown">15</span> —Å–µ–∫</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <button class="refresh-btn" id="toggle-refresh">
                        <i class="fas fa-pause"></i> –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    </button>
                </div>
            </section>

            <!-- Analysis Results -->
            <section class="analysis-results">
                <h3><i class="fas fa-chart-bar"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>

                <div class="analysis-grid">
                    <!-- Recommendation Card -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4>–¢–æ—Ä–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</h4>
                            <span class="live-indicator"></span>
                        </div>
                        <div class="recommendation" id="recommendation">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...</p>
                            </div>
                        </div>
                        <div class="confidence-score">
                            <div class="score-label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞:</div>
                            <div class="score-bar">
                                <div class="score-fill" id="confidence-fill"></div>
                            </div>
                            <span class="score-value" id="confidence-value">0%</span>
                        </div>
                    </div>

                    <!-- Trend Analysis -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4>–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–∞</h4>
                            <i class="fas fa-wave-square"></i>
                        </div>
                        <div class="analysis-content" id="trend-analysis">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Momentum Analysis -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4>–ú–æ–º–µ–Ω—Ç—É–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</h4>
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div class="analysis-content" id="momentum-analysis">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Volume Analysis -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4>–ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–º–∞</h4>
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="analysis-content" id="volume-analysis">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Technical Indicators -->
            <section class="indicators-section">
                <h3><i class="fas fa-sliders-h"></i> –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</h3>

                <div class="indicators-grid">
                    <div class="indicator-card">
                        <h4>RSI (14 –ø–µ—Ä–∏–æ–¥–æ–≤)</h4>
                        <div class="indicator-value" id="rsi-value">-</div>
                        <div class="indicator-bar">
                            <div class="indicator-fill" id="rsi-bar"></div>
                        </div>
                        <div class="indicator-signal" id="rsi-signal">-</div>
                    </div>

                    <div class="indicator-card">
                        <h4>MACD</h4>
                        <div class="indicator-value" id="macd-value">-</div>
                        <div class="indicator-signal" id="macd-signal">-</div>
                        <div class="indicator-hint" id="macd-hint">-</div>
                    </div>

                    <div class="indicator-card">
                        <h4>Bollinger Bands</h4>
                        <div class="indicator-value" id="bb-value">-</div>
                        <div class="indicator-signal" id="bb-signal">-</div>
                        <div class="indicator-hint" id="bb-hint">-</div>
                    </div>

                    <div class="indicator-card">
                        <h4>–°—Ç–æ—Ö–∞—Å—Ç–∏–∫</h4>
                        <div class="indicator-value" id="stoch-value">-</div>
                        <div class="indicator-signal" id="stoch-signal">-</div>
                        <div class="indicator-hint" id="stoch-hint">-</div>
                    </div>
                </div>
            </section>

            <!-- Pattern Detection -->
            <section class="patterns-section">
                <h3><i class="fas fa-shapes"></i> –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</h3>

                <div class="patterns-grid" id="patterns-container">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>–ü–æ–∏—Å–∫ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤...</p>
                    </div>
                </div>
            </section>

            <!-- Profit Potential -->
            <section class="profit-section">
                <h3><i class="fas fa-chart-line"></i> –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø—Ä–∏–±—ã–ª–∏</h3>

                <div class="profit-card">
                    <div class="profit-header">
                        <div class="profit-value" id="profit-value">0%</div>
                        <div class="profit-confidence" id="profit-confidence">–ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
                    </div>

                    <div class="profit-breakdown">
                        <div class="profit-item">
                            <span>–†–∏—Å–∫-–ø—Ä–æ—Ñ–∏—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ:</span>
                            <span id="risk-reward">1:0</span>
                        </div>
                        <div class="profit-item">
                            <span>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ç–æ–ø-–ª–æ—Å—Å:</span>
                            <span id="stop-loss">-</span>
                        </div>
                        <div class="profit-item">
                            <span>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Ü–µ–ª—å:</span>
                            <span id="take-profit">-</span>
                        </div>
                        <div class="profit-item">
                            <span>–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å —Ä—ã–Ω–∫–∞:</span>
                            <span id="volatility">-</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Multi-Timeframe Analysis -->
            <section class="multi-timeframe-section">
                <h3><i class="fas fa-layer-group"></i> –ê–Ω–∞–ª–∏–∑ –ø–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞–º</h3>

                <div class="timeframe-cards">
                    <div class="timeframe-card">
                        <h4>1H</h4>
                        <div class="tf-signal" id="tf-1h">-</div>
                        <div class="tf-confidence" id="tf-1h-conf">-</div>
                    </div>

                    <div class="timeframe-card">
                        <h4>4H</h4>
                        <div class="tf-signal" id="tf-4h">-</div>
                        <div class="tf-confidence" id="tf-4h-conf">-</div>
                    </div>

                    <div class="timeframe-card">
                        <h4>1D</h4>
                        <div class="tf-signal" id="tf-1d">-</div>
                        <div class="tf-confidence" id="tf-1d-conf">-</div>
                    </div>

                    <div class="timeframe-card">
                        <h4>1W</h4>
                        <div class="tf-signal" id="tf-1w">-</div>
                        <div class="tf-confidence" id="tf-1w-conf">-</div>
                    </div>
                </div>
            </section>

            <!-- Risk Calculator -->
            <section class="risk-calculator-section">
                <h3><i class="fas fa-calculator"></i> –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∏—Å–∫–∞</h3>

                <div class="calculator-grid">
                    <div class="calculator-card">
                        <h4>–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏</h4>
                        <div class="calculator-form">
                            <label>–†–∞–∑–º–µ—Ä –¥–µ–ø–æ–∑–∏—Ç–∞ ($):</label>
                            <input type="number" id="deposit-size" value="1000" min="10" step="10">

                            <label>–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (%):</label>
                            <input type="range" id="risk-percent" min="0.5" max="5" step="0.5" value="2">
                            <span id="risk-value">2%</span>

                            <div class="calculator-result">
                                <strong>–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏: <span id="position-size">$0</span></strong>
                            </div>
                        </div>
                    </div>

                    <div class="calculator-card">
                        <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–æ–º</h4>
                        <div class="management-stats">
                            <div class="management-item">
                                <span>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫:</span>
                                <span id="max-loss">$0</span>
                            </div>
                            <div class="management-item">
                                <span>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å:</span>
                                <span id="potential-profit">$0</span>
                            </div>
                            <div class="management-item">
                                <span>–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ R/R:</span>
                                <span id="rr-ratio">1:0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Additional Data -->
            <section class="additional-data-section">
                <h3><i class="fas fa-database"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>

                <div class="data-grid">
    <div class="data-card">
        <h4>–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</h4>
        <div class="price-table">
            <table>
                <thead>
                    <tr>
                        <th>–ü–µ—Ä–∏–æ–¥</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="history-data">
                    <tr><td colspan="3">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="data-card">
        <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä—ã–Ω–∫–∞</h4>
        <div class="stats-grid">
            <div class="stat-item">
                <span>–û–±—ä–µ–º (24—á):</span>
                <span id="volume-24h">-</span>
            </div>
            <div class="stat-item">
                <span>–ú–∞–∫—Å. —Ü–µ–Ω–∞ (24—á):</span>
                <span id="high-24h">-</span>
            </div>
            <div class="stat-item">
                <span>–ú–∏–Ω. —Ü–µ–Ω–∞ (24—á):</span>
                <span id="low-24h">-</span>
            </div>
            <div class="stat-item">
                <span>–ò–∑–º–µ–Ω–µ–Ω–∏–µ (24—á):</span>
                <span id="change-24h">-</span>
            </div>
        </div>
    </div>
</div>
            </section>
        </main>

        <footer class="main-footer">
            <div class="footer-content">
                <p>&copy; 2025 CryptoAnalyst Pro | –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</p>
                <p class="disclaimer">
                    <i class="fas fa-exclamation-triangle"></i>
                    –î–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π. –¢–æ—Ä–≥—É–π—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ, –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã - –≤—ã—Å–æ–∫–æ—Ä–∏—Å–∫–æ–≤—ã–µ –∞–∫—Ç–∏–≤—ã.
                </p>
            </div>
        </footer>
    </div>

    <!-- TradingView Widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <!-- TradingView Widget -->
    <!-- DUP REMOVED: tv.js -->

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º JS —Ñ–∞–π–ª—ã -->
    <script src="{{ url_for('static', filename='js/tradingview-loader.js') }}"></script>
    <script src="{{ url_for('static', filename='js/analysis-core.js') }}"></script>

<script>
// ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
const AppConfig = {
    refreshInterval: 60000, // 60 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
    apiTimeout: 15000,
    themeKey: 'cryptoanalyst_theme',
    langKey: 'cryptoanalyst_lang'
};

// ===== –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï =====
let AppState = {
    currentSymbol: 'BTCUSDT',
    currentTimeframe: '60',
    currentTheme: 'dark',
    currentLang: 'ru',
    autoRefresh: true,
    refreshTimer: null,
    countdown: 60,
    tradingViewWidget: null,
    currentData: null,
    exchange: 'BINANCE'
};

// ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ï–ú–û–ô –ò –Ø–ó–´–ö–û–ú =====
class ThemeManager {
    static init() {
        this.loadTheme();
        this.loadLanguage();
        this.setupEventListeners();
    }

    static loadTheme() {
        const savedTheme = localStorage.getItem(AppConfig.themeKey);
        const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        AppState.currentTheme = savedTheme || systemTheme;
        document.documentElement.setAttribute('data-theme', AppState.currentTheme);
        this.updateThemeIcon();
    }

    static loadLanguage() {
        const savedLang = localStorage.getItem(AppConfig.langKey) || 'ru';
        AppState.currentLang = savedLang;
        const langSwitcher = document.getElementById('langSwitcher');
        if (langSwitcher) langSwitcher.value = savedLang;
    }

    static toggleTheme() {
        AppState.currentTheme = AppState.currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', AppState.currentTheme);
        localStorage.setItem(AppConfig.themeKey, AppState.currentTheme);
        this.updateThemeIcon();
    }

    static changeLanguage(lang) {
        AppState.currentLang = lang;
        localStorage.setItem(AppConfig.langKey, lang);
    }

    static updateThemeIcon() {
        const themeIcon = document.querySelector('.theme-toggle-btn i');
        if (themeIcon) {
            themeIcon.className = AppState.currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
    }

    static setupEventListeners() {
        const themeToggle = document.getElementById('header-theme-toggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', () => this.toggleTheme());
        }

        const langSwitcher = document.getElementById('langSwitcher');
        if (langSwitcher) {
            langSwitcher.addEventListener('change', (e) => {
                this.changeLanguage(e.target.value);
            });
        }
    }
}

// ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–ú–ò =====
class DataManager {
    static loadAnalysisData(symbol, timeframe) {
        return new Promise((resolve) => {
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                fetch(`/api/analyze/${symbol}?timeframe=${timeframe}`)
                    .then(response => {
                        if (response.status === 429) {
                            console.warn('Rate limit exceeded, using fallback');
                            resolve(this.generateFallbackData(symbol, timeframe));
                            return;
                        }
                        if (!response.ok) throw new Error('HTTP error');
                        return response.json();
                    })
                    .then(data => {
                        if (data && data.success) {
                            resolve(data);
                        } else {
                            resolve(this.generateFallbackData(symbol, timeframe));
                        }
                    })
                    .catch(error => {
                        console.error('API error:', error);
                        resolve(this.generateFallbackData(symbol, timeframe));
                    });
            }, 5000); // 5 —Å–µ–∫—É–Ω–¥ –∑–∞–¥–µ—Ä–∂–∫–∏
        });
    }

    static generateFallbackData(symbol, timeframe) {
        return {
            success: true,
            symbol: symbol,
            timeframe: timeframe,
            analysis: {
                price: 2500 + Math.random() * 1000,
                price_change: (Math.random() * 10 - 5),
                recommendation: "–ù–ï–ô–¢–†–ê–õ–¨–ù–û",
                score: 50,
                confidence: "–°—Ä–µ–¥–Ω—è—è",
                trend: "–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π",
                rsi_signal: "–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π",
                macd_signal: "–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π",
                volume_signal: "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º",
                technical_indicators: {
                    rsi: (40 + Math.random() * 20).toFixed(2),
                    macd: {
                        value: (Math.random() * 0.1 - 0.05).toFixed(6),
                        signal: "–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π"
                    },
                    bollinger_bands: {
                        position: "–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π"
                    }
                }
            },
            patterns: [],
            profit_potential: {
                potential_profit: (3 + Math.random() * 7).toFixed(1) + "%",
                confidence: "–°—Ä–µ–¥–Ω—è—è",
                risk_reward_ratio: "1:" + (1.5 + Math.random() * 1.5).toFixed(1)
            },
            timestamp: new Date().toISOString()
        };
    }
}

// ===== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê =====
class UI {
    static init() {
        this.parseUrlParams();
        this.setupEventListeners();
        this.initTradingView();
        this.startAutoRefresh();
        setTimeout(() => this.refreshData(), 2000);
    }

    static parseUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        AppState.currentSymbol = urlParams.get('symbol') || 'BTCUSDT';
        AppState.currentTimeframe = urlParams.get('timeframe') || '60';

        const symbolHeader = document.getElementById('symbol-header');
        const currentSymbol = document.getElementById('current-symbol');

        if (symbolHeader) symbolHeader.textContent = `–ê–Ω–∞–ª–∏–∑ ${AppState.currentSymbol}`;
        if (currentSymbol) currentSymbol.textContent = AppState.currentSymbol;
    }

    static setupEventListeners() {
        const refreshBtn = document.getElementById('refresh-analysis');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => this.refreshData());
        }

        const toggleRefresh = document.getElementById('toggle-refresh');
        if (toggleRefresh) {
            toggleRefresh.addEventListener('click', () => {
                AppState.autoRefresh = !AppState.autoRefresh;
                this.toggleAutoRefresh();
            });
        }

        document.querySelectorAll('.timeframe-buttons .btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.timeframe-buttons .btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                AppState.currentTimeframe = btn.dataset.tf;
                this.refreshData();
            });
        });
    }

    static refreshData() {
        this.showLoadingState();

        DataManager.loadAnalysisData(AppState.currentSymbol, AppState.currentTimeframe)
            .then(data => {
                this.updateUI(data);
            })
            .catch(error => {
                console.error('Refresh error:', error);
                this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            });
    }

    static updateUI(data) {
        if (!data) return;

        this.updatePriceData(data);
        this.updateRecommendation(data.analysis);
        this.updateTrendAnalysis(data.analysis);
        this.updateMomentumAnalysis(data.analysis);
        this.updateVolumeAnalysis(data.analysis);
        this.updateIndicators(data.analysis);
        this.updatePatterns(data.patterns);
        this.updateProfitPotential(data.profit_potential);

        const updateTime = document.getElementById('update-timestamp');
        if (updateTime) updateTime.textContent = new Date().toLocaleTimeString();
    }

    static updatePriceData(data) {
        const priceElement = document.getElementById('current-price');
        const changeElement = document.getElementById('price-change');

        if (!priceElement || !changeElement) return;

        const price = data.analysis?.price || 0;
        const change = data.analysis?.price_change || 0;

        priceElement.textContent = `$${this.formatPrice(price)}`;
        changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
        changeElement.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;

        const changeIcon = changeElement.querySelector('i');
        if (changeIcon) {
            changeIcon.className = change >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
        }
    }

    static updateRecommendation(analysis) {
        const recommendationElement = document.getElementById('recommendation');
        const confidenceElement = document.getElementById('confidence-value');
        const confidenceFill = document.getElementById('confidence-fill');

        if (!recommendationElement || !confidenceElement || !confidenceFill) return;

        const recommendation = analysis?.recommendation || '–ù–ï–ô–¢–†–ê–õ–¨–ù–û';
        const score = analysis?.score || 50;
        const confidence = analysis?.confidence || '–ù–∏–∑–∫–∞—è';

        recommendationElement.innerHTML = `
            <div class="recommendation ${recommendation.toLowerCase()}">
                ${recommendation}
            </div>
            <div class="recommendation-explanation">
                ${this.getRecommendationExplanation(recommendation)}
            </div>
        `;

        confidenceElement.textContent = `${score}%`;
        confidenceFill.style.width = `${score}%`;
        confidenceFill.style.background = this.getConfidenceColor(score);
    }

    static updateTrendAnalysis(analysis) {
        const trendElement = document.getElementById('trend-analysis');
        if (!trendElement || !analysis) return;

        const trend = analysis.trend || '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';

        trendElement.innerHTML = `
            <div class="trend-info">
                <div class="trend-value ${trend.toLowerCase()}">
                    <i class="fas ${trend === '–ë—ã—á–∏–π' ? 'fa-arrow-up' : trend === '–ú–µ–¥–≤–µ–∂–∏–π' ? 'fa-arrow-down' : 'fa-minus'}"></i>
                    ${trend}
                </div>
                <div class="trend-details">
                    <p>${this.getTrendDescription(trend)}</p>
                </div>
            </div>
        `;
    }

    static updateMomentumAnalysis(analysis) {
        const momentumElement = document.getElementById('momentum-analysis');
        if (!momentumElement || !analysis) return;

        const rsiSignal = analysis.rsi_signal || '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';
        const macdSignal = analysis.macd_signal || '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';

        momentumElement.innerHTML = `
            <div class="momentum-info">
                <div class="momentum-item">
                    <span class="label">RSI:</span>
                    <span class="signal ${rsiSignal.toLowerCase()}">${rsiSignal}</span>
                </div>
                <div class="momentum-item">
                    <span class="label">MACD:</span>
                    <span class="signal ${macdSignal.toLowerCase()}">${macdSignal}</span>
                </div>
                <div class="momentum-summary">
                    <p>${this.getMomentumSummary(rsiSignal, macdSignal)}</p>
                </div>
            </div>
        `;
    }

    static updateVolumeAnalysis(analysis) {
        const volumeElement = document.getElementById('volume-analysis');
        if (!volumeElement || !analysis) return;

        const volumeSignal = analysis.volume_signal || '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º';

        volumeElement.innerHTML = `
            <div class="volume-info">
                <div class="volume-status ${volumeSignal.toLowerCase().replace(' ', '-')}">
                    <i class="fas fa-chart-bar"></i>
                    ${volumeSignal}
                </div>
                <div class="volume-details">
                    <p>${this.getVolumeDescription(volumeSignal)}</p>
                </div>
            </div>
        `;
    }

    static updateIndicators(analysis) {
        if (!analysis?.technical_indicators) return;

        const indicators = analysis.technical_indicators;

        if (indicators.rsi) {
            const rsiValue = document.getElementById('rsi-value');
            const rsiBar = document.getElementById('rsi-bar');
            const rsiSignal = document.getElementById('rsi-signal');

            if (rsiValue) rsiValue.textContent = indicators.rsi;
            if (rsiBar) {
                rsiBar.style.width = `${indicators.rsi}%`;
                rsiBar.style.background = this.getRsiColor(indicators.rsi);
            }
            if (rsiSignal) rsiSignal.textContent = this.getRsiSignal(indicators.rsi);
        }

        if (indicators.macd) {
            const macdValue = document.getElementById('macd-value');
            const macdSignal = document.getElementById('macd-signal');

            if (macdValue) macdValue.textContent = indicators.macd.value || '0';
            if (macdSignal) macdSignal.textContent = indicators.macd.signal || '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';
        }
    }

    static updatePatterns(patterns) {
        const container = document.getElementById('patterns-container');
        if (!container) return;

        if (!patterns || patterns.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <p>–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã</p>
                </div>
            `;
            return;
        }

        container.innerHTML = patterns.map(pattern => `
            <div class="pattern-card">
                <div class="pattern-header">
                    <h4>${pattern.name}</h4>
                    <span class="confidence-badge">${pattern.confidence}</span>
                </div>
                <p class="pattern-description">${pattern.description}</p>
            </div>
        `).join('');
    }

    static updateProfitPotential(profitData) {
        if (!profitData) return;

        const elements = {
            'profit-value': profitData.potential_profit,
            'profit-confidence': profitData.confidence,
            'risk-reward': profitData.risk_reward_ratio
        };

        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value || '-';
        });
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    static getTrendDescription(trend) {
        const descriptions = {
            '–ë—ã—á–∏–π': '–í–æ—Å—Ö–æ–¥—è—â–µ–µ –¥–≤–∏–∂–µ–Ω–∏–µ. –¶–µ–Ω–∞ –≤—ã—à–µ –∫–ª—é—á–µ–≤—ã—Ö —É—Ä–æ–≤–Ω–µ–π.',
            '–ú–µ–¥–≤–µ–∂–∏–π': '–ù–∏—Å—Ö–æ–¥—è—â–µ–µ –¥–≤–∏–∂–µ–Ω–∏–µ. –¶–µ–Ω–∞ –Ω–∏–∂–µ –∫–ª—é—á–µ–≤—ã—Ö —É—Ä–æ–≤–Ω–µ–π.',
            '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π': '–ë–æ–∫–æ–≤–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ. –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ —Ä—ã–Ω–∫–µ.'
        };
        return descriptions[trend] || '–¢—Ä–µ–Ω–¥ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è';
    }

    static getMomentumSummary(rsiSignal, macdSignal) {
        if (rsiSignal === '–ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å' && macdSignal === '–ú–µ–¥–≤–µ–∂–∏–π') return '–ú–µ–¥–≤–µ–∂–∏–π –º–æ–º–µ–Ω—Ç—É–º';
        if (rsiSignal === '–ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å' && macdSignal === '–ë—ã—á–∏–π') return '–ë—ã—á–∏–π –º–æ–º–µ–Ω—Ç—É–º';
        return '–ú–æ–º–µ–Ω—Ç—É–º —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω';
    }

    static getVolumeDescription(volumeSignal) {
        const descriptions = {
            '–í—ã—Å–æ–∫–∏–π –æ–±—ä–µ–º': '–ê–∫—Ç–∏–≤–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ',
            '–ù–∏–∑–∫–∏–π –æ–±—ä–µ–º': '–ù–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –≤–æ–∑–º–æ–∂–Ω–∞ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è',
            '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º': '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–æ—Ä–≥–æ–≤'
        };
        return descriptions[volumeSignal] || '–û–±—ä–µ–º –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è';
    }

    static initTradingView() {
        try {
            if (typeof TradingView === 'undefined') {
                console.warn('TradingView not available');
                return;
            }

            const symbol = `BINANCE:${AppState.currentSymbol}`;
            const interval = this.getTradingViewInterval(AppState.currentTimeframe);
            const theme = AppState.currentTheme === 'dark' ? 'dark' : 'light';

            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ –≤–∏–¥–∂–µ—Ç–∞
            const container = document.getElementById('tradingview-chart');
            if (container) container.innerHTML = '';

            new TradingView.widget({
                symbol: symbol,
                interval: interval,
                container_id: 'tradingview-chart',
                autosize: true,
                locale: 'ru',
                theme: theme,
                style: '1',
                toolbar_bg: theme === 'dark' ? '#0b0f16' : '#f1f3f6',
                enable_publishing: false,
                hide_top_toolbar: false,
                studies: ['RSI@tv-basicstudies', 'MACD@tv-basicstudies'],
                loading_screen: { backgroundColor: 'transparent' }
            });

        } catch (error) {
            console.warn('TradingView init error:', error);
        }
    }

    static getTradingViewInterval(interval) {
        const map = {
            '1': '1', '5': '5', '15': '15', '30': '30',
            '60': '60', '240': '240', 'D': '1D', 'W': '1W', 'M': '1M'
        };
        return map[interval] || '60';
    }

    static startAutoRefresh() {
        if (AppState.refreshTimer) {
            clearInterval(AppState.refreshTimer);
        }

        AppState.refreshTimer = setInterval(() => {
            if (AppState.autoRefresh) {
                if (AppState.countdown > 0) {
                    AppState.countdown--;
                    const countdownElement = document.getElementById('countdown');
                    const progressElement = document.getElementById('progress-fill');

                    if (countdownElement) countdownElement.textContent = AppState.countdown;
                    if (progressElement) {
                        progressElement.style.width = `${(100 - (AppState.countdown / 60 * 100))}%`;
                    }
                } else {
                    AppState.countdown = 60;
                    this.refreshData();
                }
            }
        }, 1000);
    }

    static toggleAutoRefresh() {
        const toggleBtn = document.getElementById('toggle-refresh');
        if (!toggleBtn) return;

        if (AppState.autoRefresh) {
            toggleBtn.innerHTML = '<i class="fas fa-play"></i> –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å';
            toggleBtn.style.background = 'var(--accent-success)';
        } else {
            toggleBtn.innerHTML = '<i class="fas fa-pause"></i> –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            toggleBtn.style.background = 'var(--accent-warning)';
        }
    }

    static showLoadingState() {
        const elements = ['#recommendation', '#trend-analysis', '#momentum-analysis', '#volume-analysis', '#patterns-container'];
        elements.forEach(selector => {
            const element = document.querySelector(selector);
            if (element) {
                element.innerHTML = `
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                    </div>
                `;
            }
        });
    }

    static showError(message) {
        const recommendationElement = document.getElementById('recommendation');
        if (recommendationElement) {
            recommendationElement.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>${message}</p>
                </div>
            `;
        }
    }

    static formatPrice(price) {
        return parseFloat(price).toFixed(2);
    }

    static getRecommendationExplanation(recommendation) {
        const explanations = {
            '–ü–û–ö–£–ü–ê–¢–¨': '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–∫—É–ø–∫—É',
            '–ü–†–û–î–ê–í–ê–¢–¨': '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–¥–∞–∂—É',
            '–ù–ï–ô–¢–†–ê–õ–¨–ù–û': '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–∂–∏–¥–∞–Ω–∏–µ'
        };
        return explanations[recommendation] || '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω';
    }

    static getConfidenceColor(score) {
        if (score >= 70) return 'var(--accent-success)';
        if (score >= 50) return 'var(--accent-warning)';
        return 'var(--accent-error)';
    }

    static getRsiColor(value) {
        value = parseFloat(value);
        if (value > 70) return 'var(--accent-error)';
        if (value < 30) return 'var(--accent-success)';
        return 'var(--accent-warning)';
    }

    static getRsiSignal(value) {
        value = parseFloat(value);
        if (value > 70) return '–ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å';
        if (value < 30) return '–ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å';
        return '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';
    }
}

// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
document.addEventListener('DOMContentLoaded', function() {
    ThemeManager.init();
    UI.init();

    const themeIcon = document.querySelector('.theme-toggle-btn i');
    if (themeIcon) {
        themeIcon.className = AppState.currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }
});
</script>

<style>
.loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: var(--text-secondary);
}

.loading-spinner {
    width: 30px;
    height: 30px;
    border: 2px solid var(--border-color);
    border-top: 2px solid var(--accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
}

.error-state {
    text-align: center;
    padding: 30px;
    color: var(--accent-error);
}

.trend-info, .momentum-info, .volume-info {
    padding: 15px;
}

.trend-value, .volume-status {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.trend-value.–±—ã—á–∏–π { color: var(--accent-success); }
.trend-value.–º–µ–¥–≤–µ–∂–∏–π { color: var(--accent-error); }
.trend-value.–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π { color: var(--accent-warning); }

.momentum-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding: 8px;
    background: var(--bg-secondary);
    border-radius: 6px;
}

.momentum-item .signal.–ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å { color: var(--accent-error); }
.momentum-item .signal.–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å { color: var(--accent-success); }
.momentum-item .signal.–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π { color: var(--accent-warning); }
.momentum-item .signal.–±—ã—á–∏–π { color: var(--accent-success); }
.momentum-item .signal.–º–µ–¥–≤–µ–∂–∏–π { color: var(--accent-error); }

.volume-status.–≤—ã—Å–æ–∫–∏–π-–æ–±—ä–µ–º { color: var(--accent-success); }
.volume-status.–Ω–∏–∑–∫–∏–π-–æ–±—ä–µ–º { color: var(--accent-error); }
.volume-status.–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π-–æ–±—ä–µ–º { color: var(--accent-warning); }
</style>

<script src="{{ url_for('static', filename='js/i18n.js') }}"></script>

</html>