<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã - CryptoAnalyst Pro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tradingview.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/inline-styles.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìà</text></svg>">

</head>
{%include '_lang_header.html'%}

    <div class="container">
        <header>
            {% include '_header.html' %}
        </header>

        <main>
            <!-- Page Header -->
            <div class="page-header">
                <div class="header-content">
                    <h2 id="symbol-header">–ê–Ω–∞–ª–∏–∑ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã</h2>
                    <div class="header-actions">
                        <span class="update-time" id="update-time">
                            <i class="fas fa-clock"></i> –û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="update-timestamp">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </span>
                        <button class="btn btn-primary" id="refresh-analysis">
                            <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>

            <!-- Price Header -->
            <section class="price-header">
                <div class="price-info">
                    <h3 id="current-symbol">{{ symbol }}</h3>
                    <div class="price-large" id="current-price">${{ "%.2f"|format(current_price) if current_price else "0.00" }}</div>
                    <div class="price-change {% if price_change >= 0 %}positive{% else %}negative{% endif %}"
                         id="price-change">
                        <i class="fas fa-arrow-{% if price_change >= 0 %}up{% else %}down{% endif %}"></i>
                        {{ "%.2f"|format(price_change|abs) }}%
                    </div>
                </div>
            </section>

            <!-- TradingView Chart -->
            <section class="chart-section">
                <div class="tradingview-widget-container">
                    <div id="tradingview-chart"></div>
                    <div class="tradingview-widget-copyright">
                        <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                            <span class="blue-text">Track –≤—Å–µ —Ä—ã–Ω–∫–∏ –Ω–∞ TradingView</span>
                        </a>
                    </div>
                </div>

                <!-- Timeframe Controls -->
                <div class="timeframe-controls">
                    <h4><i class="fas fa-chart-line"></i> –¢–∞–π–º—Ñ—Ä–µ–π–º –∞–Ω–∞–ª–∏–∑–∞</h4>
                    <div class="timeframe-buttons">
                        <button class="btn" data-tf="1">1M</button>
                        <button class="btn" data-tf="5">5M</button>
                        <button class="btn" data-tf="15">15M</button>
                        <button class="btn" data-tf="30">30M</button>
                        <button class="btn active" data-tf="60">1H</button>
                        <button class="btn" data-tf="240">4H</button>
                        <button class="btn" data-tf="D">1D</button>
                        <button class="btn" data-tf="W">1W</button>
                    </div>
                </div>
            </section>

            <!-- Auto Refresh Section -->
            <section class="auto-refresh-section">
                <div class="refresh-controls">
                    <h4><i class="fas fa-sync-alt"></i> –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h4>
                    <div class="refresh-status">
                        <span class="live-indicator"></span>
                        <span>–°–ª–µ–¥—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑: <span id="countdown">15</span> —Å–µ–∫</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <button class="refresh-btn" id="toggle-refresh">
                        <i class="fas fa-pause"></i> –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    </button>
                </div>
            </section>

            <!-- Analysis Results -->
            <section class="analysis-results">
                <h3><i class="fas fa-chart-bar"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>

                <div class="analysis-grid">
                    <!-- Recommendation Card -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4>–¢–æ—Ä–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</h4>
                            <span class="live-indicator"></span>
                        </div>
                        <div class="recommendation" id="recommendation">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...</p>
                            </div>
                        </div>
                        <div class="confidence-score">
                            <div class="score-label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞:</div>
                            <div class="score-bar">
                                <div class="score-fill" id="confidence-fill"></div>
                            </div>
                            <span class="score-value" id="confidence-value">0%</span>
                        </div>
                    </div>

                    <!-- Trend Analysis -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4>–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–∞</h4>
                            <i class="fas fa-wave-square"></i>
                        </div>
                        <div class="analysis-content" id="trend-analysis">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Momentum Analysis -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4>–ú–æ–º–µ–Ω—Ç—É–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</h4>
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div class="analysis-content" id="momentum-analysis">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Volume Analysis -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4>–ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–º–∞</h4>
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="analysis-content" id="volume-analysis">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Technical Indicators -->
            <section class="indicators-section">
                <h3><i class="fas fa-sliders-h"></i> –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</h3>

                <div class="indicators-grid">
                    <div class="indicator-card">
                        <h4>RSI (14 –ø–µ—Ä–∏–æ–¥–æ–≤)</h4>
                        <div class="indicator-value" id="rsi-value">-</div>
                        <div class="indicator-bar">
                            <div class="indicator-fill" id="rsi-bar"></div>
                        </div>
                        <div class="indicator-signal" id="rsi-signal">-</div>
                    </div>

                    <div class="indicator-card">
                        <h4>MACD</h4>
                        <div class="indicator-value" id="macd-value">-</div>
                        <div class="indicator-signal" id="macd-signal">-</div>
                        <div class="indicator-hint" id="macd-hint">-</div>
                    </div>

                    <div class="indicator-card">
                        <h4>Bollinger Bands</h4>
                        <div class="indicator-value" id="bb-value">-</div>
                        <div class="indicator-signal" id="bb-signal">-</div>
                        <div class="indicator-hint" id="bb-hint">-</div>
                    </div>

                    <div class="indicator-card">
                        <h4>–°—Ç–æ—Ö–∞—Å—Ç–∏–∫</h4>
                        <div class="indicator-value" id="stoch-value">-</div>
                        <div class="indicator-signal" id="stoch-signal">-</div>
                        <div class="indicator-hint" id="stoch-hint">-</div>
                    </div>
                </div>
            </section>

            <!-- Pattern Detection -->
            <section class="patterns-section">
                <h3><i class="fas fa-shapes"></i> –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</h3>

                <div class="patterns-grid" id="patterns-container">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>–ü–æ–∏—Å–∫ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤...</p>
                    </div>
                </div>
            </section>

            <!-- Profit Potential -->
            <section class="profit-section">
                <h3><i class="fas fa-chart-line"></i> –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø—Ä–∏–±—ã–ª–∏</h3>

                <div class="profit-card">
                    <div class="profit-header">
                        <div class="profit-value" id="profit-value">0%</div>
                        <div class="profit-confidence" id="profit-confidence">–ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
                    </div>

                    <div class="profit-breakdown">
                        <div class="profit-item">
                            <span>–†–∏—Å–∫-–ø—Ä–æ—Ñ–∏—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ:</span>
                            <span id="risk-reward">1:0</span>
                        </div>
                        <div class="profit-item">
                            <span>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ç–æ–ø-–ª–æ—Å—Å:</span>
                            <span id="stop-loss">-</span>
                        </div>
                        <div class="profit-item">
                            <span>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Ü–µ–ª—å:</span>
                            <span id="take-profit">-</span>
                        </div>
                        <div class="profit-item">
                            <span>–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å —Ä—ã–Ω–∫–∞:</span>
                            <span id="volatility">-</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Multi-Timeframe Analysis -->
            <section class="multi-timeframe-section">
                <h3><i class="fas fa-layer-group"></i> –ê–Ω–∞–ª–∏–∑ –ø–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞–º</h3>

                <div class="timeframe-cards">
                    <div class="timeframe-card">
                        <h4>1H</h4>
                        <div class="tf-signal" id="tf-1h">-</div>
                        <div class="tf-confidence" id="tf-1h-conf">-</div>
                    </div>

                    <div class="timeframe-card">
                        <h4>4H</h4>
                        <div class="tf-signal" id="tf-4h">-</div>
                        <div class="tf-confidence" id="tf-4h-conf">-</div>
                    </div>

                    <div class="timeframe-card">
                        <h4>1D</h4>
                        <div class="tf-signal" id="tf-1d">-</div>
                        <div class="tf-confidence" id="tf-1d-conf">-</div>
                    </div>

                    <div class="timeframe-card">
                        <h4>1W</h4>
                        <div class="tf-signal" id="tf-1w">-</div>
                        <div class="tf-confidence" id="tf-1w-conf">-</div>
                    </div>
                </div>
            </section>

            <!-- Risk Calculator -->
            <section class="risk-calculator-section">
                <h3><i class="fas fa-calculator"></i> –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∏—Å–∫–∞</h3>

                <div class="calculator-grid">
                    <div class="calculator-card">
                        <h4>–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏</h4>
                        <div class="calculator-form">
                            <label>–†–∞–∑–º–µ—Ä –¥–µ–ø–æ–∑–∏—Ç–∞ ($):</label>
                            <input type="number" id="deposit-size" value="1000" min="10" step="10">

                            <label>–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (%):</label>
                            <input type="range" id="risk-percent" min="0.5" max="5" step="0.5" value="2">
                            <span id="risk-value">2%</span>

                            <div class="calculator-result">
                                <strong>–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏: <span id="position-size">$0</span></strong>
                            </div>
                        </div>
                    </div>

                    <div class="calculator-card">
                        <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–æ–º</h4>
                        <div class="management-stats">
                            <div class="management-item">
                                <span>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫:</span>
                                <span id="max-loss">$0</span>
                            </div>
                            <div class="management-item">
                                <span>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å:</span>
                                <span id="potential-profit">$0</span>
                            </div>
                            <div class="management-item">
                                <span>–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ R/R:</span>
                                <span id="rr-ratio">1:0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Additional Data -->
            <section class="additional-data-section">
                <h3><i class="fas fa-database"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>

                <div class="data-grid">
    <div class="data-card">
        <h4>–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</h4>
        <div class="price-table">
            <table>
                <thead>
                    <tr>
                        <th>–ü–µ—Ä–∏–æ–¥</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="history-data">
                    <tr><td colspan="3">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="data-card">
        <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä—ã–Ω–∫–∞</h4>
        <div class="stats-grid">
            <div class="stat-item">
                <span>–û–±—ä–µ–º (24—á):</span>
                <span id="volume-24h">-</span>
            </div>
            <div class="stat-item">
                <span>–ú–∞–∫—Å. —Ü–µ–Ω–∞ (24—á):</span>
                <span id="high-24h">-</span>
            </div>
            <div class="stat-item">
                <span>–ú–∏–Ω. —Ü–µ–Ω–∞ (24—á):</span>
                <span id="low-24h">-</span>
            </div>
            <div class="stat-item">
                <span>–ò–∑–º–µ–Ω–µ–Ω–∏–µ (24—á):</span>
                <span id="change-24h">-</span>
            </div>
        </div>
    </div>
</div>
            </section>
        </main>

        <footer class="main-footer">
            <div class="footer-content">
                <p>&copy; 2025 CryptoAnalyst Pro | –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</p>
                <p class="disclaimer">
                    <i class="fas fa-exclamation-triangle"></i>
                    –î–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π. –¢–æ—Ä–≥—É–π—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ, –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã - –≤—ã—Å–æ–∫–æ—Ä–∏—Å–∫–æ–≤—ã–µ –∞–∫—Ç–∏–≤—ã.
                </p>
            </div>
        </footer>
    </div>

    <!-- TradingView Widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <!-- TradingView Widget -->
    <!-- DUP REMOVED: tv.js -->

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º JS —Ñ–∞–π–ª—ã -->
    <script src="{{ url_for('static', filename='js/tradingview-loader.js') }}"></script>
    <script src="{{ url_for('static', filename='js/analysis-core.js') }}"></script>

<script>
// ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
const AppConfig = {
    refreshInterval: 30000, // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ 30 —Å–µ–∫—É–Ω–¥
    apiTimeout: 15000,
    themeKey: 'cryptoanalyst_theme',
    langKey: 'cryptoanalyst_lang'
};

// ===== –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï =====
let AppState = {
    currentSymbol: 'BTCUSDT',
    currentTimeframe: '60',
    currentTheme: 'dark',
    currentLang: 'ru',
    autoRefresh: true,
    refreshTimer: null,
    countdown: 30, // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ 30 —Å–µ–∫—É–Ω–¥
    tradingViewWidget: null,
    currentData: null,
    exchange: 'BINANCE'
};

// ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ï–ú–û–ô –ò –Ø–ó–´–ö–û–ú =====
class ThemeManager {
    static init() {
        this.loadTheme();
        this.loadLanguage();
        this.setupEventListeners();
    }

    static loadTheme() {
        const savedTheme = localStorage.getItem(AppConfig.themeKey);
        const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        AppState.currentTheme = savedTheme || systemTheme;
        document.documentElement.setAttribute('data-theme', AppState.currentTheme);
        this.updateThemeIcon();
    }

    static loadLanguage() {
        const savedLang = localStorage.getItem(AppConfig.langKey) || 'ru';
        AppState.currentLang = savedLang;
        const langSwitcher = document.getElementById('langSwitcher');
        if (langSwitcher) langSwitcher.value = savedLang;
    }

    static toggleTheme() {
        AppState.currentTheme = AppState.currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', AppState.currentTheme);
        localStorage.setItem(AppConfig.themeKey, AppState.currentTheme);
        this.updateThemeIcon();
    }

    static changeLanguage(lang) {
        AppState.currentLang = lang;
        localStorage.setItem(AppConfig.langKey, lang);
        console.log('Language changed to:', lang);
    }

    static updateThemeIcon() {
        const themeIcon = document.querySelector('.theme-toggle-btn i');
        if (themeIcon) {
            themeIcon.className = AppState.currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
    }

    static setupEventListeners() {
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
        const themeToggle = document.getElementById('header-theme-toggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', () => this.toggleTheme());
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞
        const langSwitcher = document.getElementById('langSwitcher');
        if (langSwitcher) {
            langSwitcher.addEventListener('change', (e) => {
                this.changeLanguage(e.target.value);
            });
        }
    }
}

// ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–ú–ò =====
class DataManager {
    static async loadAnalysisData(symbol, timeframe) {
        try {
            // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 60 —Å–µ–∫—É–Ω–¥
            const cacheKey = `analysis_${symbol}_${timeframe}`;
            const cachedData = sessionStorage.getItem(cacheKey);
            const cachedTime = sessionStorage.getItem(`${cacheKey}_time`);

            if (cachedData && cachedTime && (Date.now() - cachedTime < 60000)) {
                return JSON.parse(cachedData);
            }

            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ 3 —Å–µ–∫—É–Ω–¥
            await new Promise(resolve => setTimeout(resolve, 3000));

            const response = await fetch(`/api/analyze/${symbol}?timeframe=${timeframe}`);

            if (response.status === 429) {
                // –ü—Ä–∏ 429 –æ—à–∏–±–∫–µ –∂–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null
                await new Promise(resolve => setTimeout(resolve, 10000));
                return null;
            }

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Unknown error');
            }

            sessionStorage.setItem(cacheKey, JSON.stringify(data));
            sessionStorage.setItem(`${cacheKey}_time`, Date.now());

            return data;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞:', error);
            return null;
        }
    }
}

// ===== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê =====
class UI {
    static init() {
        this.parseUrlParams();
        this.setupEventListeners();
        this.initTradingView();
        this.startAutoRefresh();
        setTimeout(() => {
            this.refreshData();
            this.loadAdditionalData(); // ‚Üê –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –°–¢–†–û–ß–ö–£
        }, 2000);
    }

    static parseUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        AppState.currentSymbol = urlParams.get('symbol') || 'BTCUSDT';
        AppState.currentTimeframe = urlParams.get('timeframe') || '60';

        const symbolHeader = document.getElementById('symbol-header');
        const currentSymbol = document.getElementById('current-symbol');

        if (symbolHeader) symbolHeader.textContent = `–ê–Ω–∞–ª–∏–∑ ${AppState.currentSymbol}`;
        if (currentSymbol) currentSymbol.textContent = AppState.currentSymbol;
    }

    static setupEventListeners() {
        // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        const refreshBtn = document.getElementById('refresh-analysis');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => this.refreshData());
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        const toggleRefresh = document.getElementById('toggle-refresh');
        if (toggleRefresh) {
            toggleRefresh.addEventListener('click', () => {
                AppState.autoRefresh = !AppState.autoRefresh;
                this.toggleAutoRefresh();
            });
        }

        // –ö–Ω–æ–ø–∫–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
        document.querySelectorAll('.timeframe-buttons .btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.timeframe-buttons .btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                AppState.currentTimeframe = btn.dataset.tf;
                this.refreshData();
            });
        });
    }

    static async refreshData() {
    try {
        this.showLoadingState();
        await new Promise(resolve => setTimeout(resolve, 1500));
        const data = await DataManager.loadAnalysisData(AppState.currentSymbol, AppState.currentTimeframe);

        if (data) {
            this.updateUI(data);
            this.loadAdditionalData(); // ‚Üê –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –°–¢–†–û–ß–ö–£
        } else {
            this.showError('–î–∞–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
        this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    }
}

    static updateUI(data) {
        if (!data) return;

        this.updatePriceData(data);
        this.updateRecommendation(data.analysis);
        this.updateTrendAnalysis(data.analysis);
        this.updateMomentumAnalysis(data.analysis);
        this.updateVolumeAnalysis(data.analysis);
        this.updateIndicators(data.analysis);
        this.updatePatterns(data.patterns);
        this.updateProfitPotential(data.profit_potential);

        const updateTime = document.getElementById('update-timestamp');
        if (updateTime) updateTime.textContent = new Date().toLocaleTimeString();
    }

    static updatePriceData(data) {
        const priceElement = document.getElementById('current-price');
        const changeElement = document.getElementById('price-change');

        if (!priceElement || !changeElement) return;

        const price = data.analysis?.price || 0;
        const change = data.analysis?.price_change || 0;

        priceElement.textContent = `$${this.formatPrice(price)}`;
        changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
        changeElement.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;

        const changeIcon = changeElement.querySelector('i');
        if (changeIcon) {
            changeIcon.className = change >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
        }
    }

    static updateRecommendation(analysis) {
        const recommendationElement = document.getElementById('recommendation');
        const confidenceElement = document.getElementById('confidence-value');
        const confidenceFill = document.getElementById('confidence-fill');

        if (!recommendationElement || !confidenceElement || !confidenceFill) return;

        if (!analysis) {
            recommendationElement.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>–î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</p>
                </div>
            `;
            return;
        }

        const recommendation = analysis.recommendation || '–ù–ï–ô–¢–†–ê–õ–¨–ù–û';
        const score = analysis.score || 50;
        const confidence = analysis.confidence || '–ù–∏–∑–∫–∞—è';

        recommendationElement.innerHTML = `
            <div class="recommendation ${recommendation.toLowerCase()}">
                ${recommendation}
            </div>
            <div class="recommendation-explanation">
                ${this.getRecommendationExplanation(recommendation)}
            </div>
        `;

        confidenceElement.textContent = `${score}%`;
        confidenceFill.style.width = `${score}%`;
        confidenceFill.style.background = this.getConfidenceColor(score);
    }

    static updateTrendAnalysis(analysis) {
        const trendElement = document.getElementById('trend-analysis');
        if (!trendElement || !analysis) return;

        const trend = analysis.trend || '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';
        const trendStrength = this.getTrendStrength(analysis);

        trendElement.innerHTML = `
            <div class="trend-info">
                <div class="trend-value ${trend.toLowerCase()}">
                    <i class="fas ${trend === '–ë—ã—á–∏–π' ? 'fa-arrow-up' : trend === '–ú–µ–¥–≤–µ–∂–∏–π' ? 'fa-arrow-down' : 'fa-minus'}"></i>
                    ${trend}
                </div>
                <div class="trend-strength">
                    –°–∏–ª–∞: ${trendStrength}
                </div>
                <div class="trend-details">
                    <p>${this.getTrendDescription(trend, analysis)}</p>
                </div>
            </div>
        `;
    }

    static updateMomentumAnalysis(analysis) {
        const momentumElement = document.getElementById('momentum-analysis');
        if (!momentumElement || !analysis) return;

        const rsi = analysis.rsi || 50;
        const rsiSignal = analysis.rsi_signal || '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';
        const macdSignal = analysis.macd_signal || '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';

        momentumElement.innerHTML = `
            <div class="momentum-info">
                <div class="momentum-item">
                    <span class="label">RSI:</span>
                    <span class="value ${this.getRsiStatus(rsi)}">${rsi}</span>
                    <span class="signal">(${rsiSignal})</span>
                </div>
                <div class="momentum-item">
                    <span class="label">MACD:</span>
                    <span class="value ${macdSignal.toLowerCase()}">${macdSignal}</span>
                </div>
                <div class="momentum-summary">
                    <p>${this.getMomentumSummary(rsiSignal, macdSignal)}</p>
                </div>
            </div>
        `;
    }

    static updateVolumeAnalysis(analysis) {
        const volumeElement = document.getElementById('volume-analysis');
        if (!volumeElement || !analysis) return;

        const volumeSignal = analysis.volume_signal || '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π';
        const volumeDescription = this.getVolumeDescription(volumeSignal);

        volumeElement.innerHTML = `
            <div class="volume-info">
                <div class="volume-status ${volumeSignal.toLowerCase().replace(' ', '-')}">
                    <i class="fas ${volumeSignal === '–í—ã—Å–æ–∫–∏–π –æ–±—ä–µ–º' ? 'fa-chart-bar' : volumeSignal === '–ù–∏–∑–∫–∏–π –æ–±—ä–µ–º' ? 'fa-chart-line' : 'fa-chart-area'}"></i>
                    ${volumeSignal}
                </div>
                <div class="volume-details">
                    <p>${volumeDescription}</p>
                </div>
                <div class="volume-impact">
                    –í–ª–∏—è–Ω–∏–µ: ${this.getVolumeImpact(volumeSignal)}
                </div>
            </div>
        `;
    }

    static updateIndicators(analysis) {
        if (!analysis?.technical_indicators) return;

        const indicators = analysis.technical_indicators;

        // RSI
        if (indicators.rsi) {
            const rsiValue = document.getElementById('rsi-value');
            const rsiBar = document.getElementById('rsi-bar');
            const rsiSignal = document.getElementById('rsi-signal');

            if (rsiValue) rsiValue.textContent = indicators.rsi;
            if (rsiBar) {
                rsiBar.style.width = `${indicators.rsi}%`;
                rsiBar.style.background = this.getRsiColor(indicators.rsi);
            }
            if (rsiSignal) rsiSignal.textContent = this.getRsiSignal(indicators.rsi);
        }

        // MACD
        if (indicators.macd) {
            const macdValue = document.getElementById('macd-value');
            const macdSignal = document.getElementById('macd-signal');
            const macdHint = document.getElementById('macd-hint');

            if (macdValue && indicators.macd.value) {
                macdValue.textContent = parseFloat(indicators.macd.value).toFixed(4);
            }
            if (macdSignal && indicators.macd.signal) {
                macdSignal.textContent = indicators.macd.signal;
            }
            if (macdHint && indicators.macd.value && indicators.macd.signal) {
                macdHint.textContent = this.getMacdHint(parseFloat(indicators.macd.value), indicators.macd.signal);
            }
        }

        // Bollinger Bands
        if (indicators.bollinger_bands) {
            const bbValue = document.getElementById('bb-value');
            const bbSignal = document.getElementById('bb-signal');

            if (bbValue) bbValue.textContent = indicators.bollinger_bands.position || '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';
            if (bbSignal) bbSignal.textContent = this.getBollingerSignal(indicators.bollinger_bands.position);
        }
    }

    static updatePatterns(patterns) {
        const container = document.getElementById('patterns-container');
        if (!container) return;

        if (!patterns || patterns.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <p>–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã</p>
                    <small>–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</small>
                </div>
            `;
            return;
        }

        container.innerHTML = patterns.map(pattern => `
            <div class="pattern-card">
                <div class="pattern-header">
                    <h4>${pattern.name}</h4>
                    <span class="confidence-badge ${pattern.confidence.toLowerCase()}">
                        ${pattern.confidence}
                    </span>
                </div>
                <div class="pattern-type">–¢–∏–ø: ${pattern.type}</div>
                <p class="pattern-description">${pattern.description}</p>
                ${pattern.easter_egg ? `<div class="pattern-hint">üí° ${pattern.easter_egg}</div>` : ''}
            </div>
        `).join('');
    }

    static updateProfitPotential(profitData) {
        if (!profitData) return;

        const elements = {
            'profit-value': profitData.potential_profit,
            'profit-confidence': profitData.confidence,
            'risk-reward': profitData.risk_reward_ratio,
            'stop-loss': profitData.stop_loss,
            'take-profit': profitData.take_profit,
            'volatility': profitData.volatility_based
        };

        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value || '-';
        });
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    static getTrendStrength(analysis) {
        if (!analysis) return '–°—Ä–µ–¥–Ω—è—è';
        const score = analysis.score || 50;

        if (score >= 80) return '–û—á–µ–Ω—å —Å–∏–ª—å–Ω–∞—è';
        if (score >= 60) return '–°–∏–ª—å–Ω–∞—è';
        if (score >= 40) return '–°—Ä–µ–¥–Ω—è—è';
        return '–°–ª–∞–±–∞—è';
    }

    static getTrendDescription(trend, analysis) {
        const descriptions = {
            '–ë—ã—á–∏–π': '–¶–µ–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤—ã—à–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–∫–æ–ª—å–∑—è—â–∏—Ö —Å—Ä–µ–¥–Ω–∏—Ö. –í–æ—Å—Ö–æ–¥—è—â–µ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.',
            '–ú–µ–¥–≤–µ–∂–∏–π': '–¶–µ–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∏–∂–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–∫–æ–ª—å–∑—è—â–∏—Ö —Å—Ä–µ–¥–Ω–∏—Ö. –ù–∏—Å—Ö–æ–¥—è—â–µ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è.',
            '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π': '–¶–µ–Ω–∞ –≤ –±–æ–∫–æ–≤–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞ –Ω–µ—Ç.'
        };
        return descriptions[trend] || '–¢—Ä–µ–Ω–¥ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
    }

    static getRsiStatus(rsi) {
        rsi = parseFloat(rsi);
        if (rsi > 70) return 'overbought';
        if (rsi < 30) return 'oversold';
        return 'neutral';
    }

    static getMomentumSummary(rsiSignal, macdSignal) {
        if (rsiSignal === '–ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å' && macdSignal === '–ú–µ–¥–≤–µ–∂–∏–π') {
            return '–°–∏–ª—å–Ω—ã–π –º–µ–¥–≤–µ–∂–∏–π –º–æ–º–µ–Ω—Ç—É–º. –í–æ–∑–º–æ–∂–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏—è.';
        }
        if (rsiSignal === '–ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å' && macdSignal === '–ë—ã—á–∏–π') {
            return '–°–∏–ª—å–Ω—ã–π –±—ã—á–∏–π –º–æ–º–µ–Ω—Ç—É–º. –í–æ–∑–º–æ–∂–µ–Ω –æ—Ç—Å–∫–æ–∫.';
        }
        if (rsiSignal === '–ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å') {
            return '–ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å –ø–æ–∫—É–ø–∫–∞–º–∏.';
        }
        if (rsiSignal === '–ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å') {
            return '–ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å. –í–æ–∑–º–æ–∂–Ω—ã —Ö–æ—Ä–æ—à–∏–µ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞.';
        }
        return '–ú–æ–º–µ–Ω—Ç—É–º —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω. –û–∂–∏–¥–∞–π—Ç–µ —Å–∏–≥–Ω–∞–ª–æ–≤.';
    }

    static getVolumeDescription(volumeSignal) {
        const descriptions = {
            '–í—ã—Å–æ–∫–∏–π –æ–±—ä–µ–º': '–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ–±—ä–µ–º–∞ —Ç–æ—Ä–≥–æ–≤. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Å–∏–ª—É –¥–≤–∏–∂–µ–Ω–∏—è.',
            '–ù–∏–∑–∫–∏–π –æ–±—ä–µ–º': '–ù–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å traders. –í–æ–∑–º–æ–∂–Ω–∞ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è.',
            '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º': '–û–±—ä–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ä–µ–¥–Ω–∏–º –∑–Ω–∞—á–µ–Ω–∏—è–º. –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ.'
        };
        return descriptions[volumeSignal] || '–û–±—ä–µ–º –Ω–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω';
    }

    static getVolumeImpact(volumeSignal) {
        const impacts = {
            '–í—ã—Å–æ–∫–∏–π –æ–±—ä–µ–º': '–í—ã—Å–æ–∫–æ–µ',
            '–ù–∏–∑–∫–∏–π –æ–±—ä–µ–º': '–ù–∏–∑–∫–æ–µ',
            '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º': '–°—Ä–µ–¥–Ω–µ–µ'
        };
        return impacts[volumeSignal] || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';
    }

    static getBollingerSignal(position) {
        const signals = {
            '–í—ã—à–µ –≤–µ—Ä—Ö–Ω–µ–π –ø–æ–ª–æ—Å—ã': '–ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å',
            '–ù–∏–∂–µ –Ω–∏–∂–Ω–µ–π –ø–æ–ª–æ—Å—ã': '–ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å',
            '–í–µ—Ä—Ö–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∞': '–ë—ã—á–∏–π –Ω–∞—Å—Ç—Ä–æ–π',
            '–ù–∏–∂–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∞': '–ú–µ–¥–≤–µ–∂–∏–π –Ω–∞—Å—Ç—Ä–æ–π'
        };
        return signals[position] || '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    static initTradingView() {
    try {
        if (typeof TradingView === 'undefined') {
            console.warn('TradingView not available');
            return;
        }

        const symbol = `BINANCE:${AppState.currentSymbol}`;
        const interval = this.getTradingViewInterval(AppState.currentTimeframe);
        const theme = AppState.currentTheme === 'dark' ? 'dark' : 'light';

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≤–∏–¥–∂–µ—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
        if (AppState.tradingViewWidget) {
            try {
                AppState.tradingViewWidget.remove();
            } catch (e) {
                console.warn('Error removing old widget:', e);
            }
        }

        AppState.tradingViewWidget = new TradingView.widget({
            symbol: symbol,
            interval: interval,
            container_id: 'tradingview-chart',
            autosize: true,
            locale: 'ru',
            theme: theme,
            style: '1',
            toolbar_bg: theme === 'dark' ? '#0b0f16' : '#f1f3f6',
            enable_publishing: false,
            hide_top_toolbar: false,
            studies: ['RSI@tv-basicstudies', 'MACD@tv-basicstudies', 'Volume@tv-basicstudies'],
            drawings_access: {
                type: 'all',
                tools: [
                    { name: 'Regression Trend' },
                    { name: 'Trend Line' },
                    { name: 'Horizontal Line' },
                    { name: 'Vertical Line' }
                ]
            },
            overrides: {
                "paneProperties.background": theme === 'dark' ? "#131722" : "#FFFFFF",
                "mainSeriesProperties.candleStyle.upColor": theme === 'dark' ? "#26a69a" : "#089981",
                "mainSeriesProperties.candleStyle.downColor": theme === 'dark' ? "#ef5350" : "#f23645"
            },
            loading_screen: { backgroundColor: 'transparent' }
        });

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
        this.syncTimeframeButtons();

    } catch (error) {
        console.warn('TradingView init error:', error);
    }
    }

    static syncTimeframeButtons() {
        const buttons = document.querySelectorAll('.timeframe-buttons .btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const timeframe = btn.dataset.tf;
                this.changeTradingViewTimeframe(timeframe);
            });
        });
    }

    static changeTradingViewTimeframe(timeframe) {
        if (!AppState.tradingViewWidget) return;

        try {
            const tvInterval = this.getTradingViewInterval(timeframe);
            AppState.tradingViewWidget.chart().setResolution(tvInterval);
        } catch (error) {
            console.warn('Error changing timeframe:', error);
            // –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ API, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –≤–∏–¥–∂–µ—Ç
            this.initTradingView();
        }
    }

    static getTradingViewInterval(interval) {
        const map = {
            '1': '1',
            '5': '5',
            '15': '15',
            '30': '30',
            '60': '60',
            '240': '240',
            'D': '1D',
            'W': '1W',
            'M': '1M'
        };
        return map[interval] || '60';
    }

    static startAutoRefresh() {
        if (AppState.refreshTimer) {
            clearInterval(AppState.refreshTimer);
        }

        AppState.refreshTimer = setInterval(() => {
            if (AppState.autoRefresh) {
                if (AppState.countdown > 0) {
                    AppState.countdown--;
                    const countdownElement = document.getElementById('countdown');
                    const progressElement = document.getElementById('progress-fill');

                    if (countdownElement) countdownElement.textContent = AppState.countdown;
                    if (progressElement) {
                        progressElement.style.width = `${(100 - (AppState.countdown / 30 * 100))}%`;
                    }
                } else {
                    AppState.countdown = 30;
                    this.refreshData();
                }
            }
        }, 1000);
    }

    static toggleAutoRefresh() {
        const toggleBtn = document.getElementById('toggle-refresh');
        if (!toggleBtn) return;

        if (AppState.autoRefresh) {
            toggleBtn.innerHTML = '<i class="fas fa-play"></i> –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å';
            toggleBtn.style.background = 'var(--accent-success)';
        } else {
            toggleBtn.innerHTML = '<i class="fas fa-pause"></i> –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            toggleBtn.style.background = 'var(--accent-warning)';
        }
    }

    static showLoadingState() {
        const elements = ['#recommendation', '#trend-analysis', '#momentum-analysis', '#volume-analysis', '#patterns-container'];
        elements.forEach(selector => {
            const element = document.querySelector(selector);
            if (element) {
                element.innerHTML = `
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞...</p>
                    </div>
                `;
            }
        });
    }

    static showError(message) {
        const recommendationElement = document.getElementById('recommendation');
        if (recommendationElement) {
            recommendationElement.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="UI.refreshData()">
                        <i class="fas fa-sync-alt"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            `;
        }
    }

    static formatPrice(price) {
        return parseFloat(price).toFixed(2);
    }

    static getRecommendationExplanation(recommendation) {
        const explanations = {
            '–ü–û–ö–£–ü–ê–¢–¨': '–°–∏–ª—å–Ω—ã–µ –±—ã—á—å–∏ —Å–∏–≥–Ω–∞–ª—ã –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞—Ö',
            '–ü–†–û–î–ê–í–ê–¢–¨': '–ß–µ—Ç–∫–∏–µ –º–µ–¥–≤–µ–∂—å–∏ —Å–∏–≥–Ω–∞–ª—ã –∏ —Å–ª–∞–±–æ—Å—Ç—å —Ü–µ–Ω—ã',
            '–ù–ï–ô–¢–†–ê–õ–¨–ù–û': '–°–º–µ—à–∞–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–∂–∏–¥–∞–Ω–∏–µ'
        };
        return explanations[recommendation] || '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω';
    }

    static getConfidenceColor(score) {
        if (score >= 70) return 'var(--accent-success)';
        if (score >= 50) return 'var(--accent-warning)';
        return 'var(--accent-error)';
    }

    static getRsiColor(value) {
        value = parseFloat(value);
        if (value > 70) return 'var(--accent-error)';
        if (value < 30) return 'var(--accent-success)';
        return 'var(--accent-warning)';
    }

    static getRsiSignal(value) {
        value = parseFloat(value);
        if (value > 70) return '–ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å';
        if (value < 30) return '–ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å';
        return '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';
    }

    static getMacdHint(value, signal) {
        if (value > 0 && signal === '–ë—ã—á–∏–π') return '–°–∏–ª—å–Ω—ã–π –±—ã—á–∏–π —Å–∏–≥–Ω–∞–ª';
        if (value < 0 && signal === '–ú–µ–¥–≤–µ–∂–∏–π') return '–°–∏–ª—å–Ω—ã–π –º–µ–¥–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª';
        return '–°–∏–≥–Ω–∞–ª –Ω–µ—è—Å–µ–Ω';
    }
}

// –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–ª–∞—Å—Å DataManager
static async loadHistoricalData(symbol) {
    try {
        const response = await fetch(`/api/historical-data/${symbol}`);
        if (!response.ok) return null;
        const data = await response.json();
        return data.success ? data : null;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
        return null;
    }
}

static async loadMarketStats(symbol) {
    try {
        const response = await fetch(`/api/market-statistics/${symbol}`);  // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π endpoint
        if (!response.ok) return null;
        const data = await response.json();
        return data.success ? data : null;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        return null;
    }
}

// –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–ª–∞—Å—Å UI
static async loadAdditionalData() {
    try {
        const [historicalData, marketStats] = await Promise.all([
            DataManager.loadHistoricalData(AppState.currentSymbol),
            DataManager.loadMarketStats(AppState.currentSymbol)
        ]);

        this.updateHistoricalData(historicalData);
        this.updateMarketStats(marketStats);
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
    }
}

static updateHistoricalData(data) {
    const container = document.getElementById('history-data');
    if (!container) return;

    if (!data || !data.historical_data) {
        container.innerHTML = '<tr><td colspan="3">–î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</td></tr>';
        return;
    }

    container.innerHTML = data.historical_data.map(item => {
        const timeframeName = this.formatTimeframe(item.timeframe);
        return `
            <tr>
                <td>${timeframeName}</td>
                <td>$${this.formatPrice(item.price)}</td>
                <td class="${item.change >= 0 ? 'positive' : 'negative'}">
                    ${item.change >= 0 ? '+' : ''}${item.change.toFixed(2)}%
                </td>
            </tr>
        `;
    }).join('');
}

static updateMarketStats(data) {
    if (!data) return;

    const elements = {
        'volume-24h': data.volume_24h ? `$${this.formatNumber(data.volume_24h)}` : '-',
        'high-24h': data.high_24h ? `$${this.formatPrice(data.high_24h)}` : '-',
        'low-24h': data.low_24h ? `$${this.formatPrice(data.low_24h)}` : '-',
        'change-24h': data.price_change ?
            `<span class="${data.price_change >= 0 ? 'positive' : 'negative'}">
                ${data.price_change >= 0 ? '+' : ''}${data.price_change.toFixed(2)}%
            </span>` : '-'
    };

    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) element.innerHTML = value;
    });
}

static formatTimeframe(tf) {
    const map = {
        '1': '1 –º–∏–Ω—É—Ç–∞',
        '5': '5 –º–∏–Ω—É—Ç',
        '15': '15 –º–∏–Ω—É—Ç',
        '30': '30 –º–∏–Ω—É—Ç',
        '60': '1 —á–∞—Å',
        '240': '4 —á–∞—Å–∞',
        'D': '1 –¥–µ–Ω—å',
        'W': '1 –Ω–µ–¥–µ–ª—è',
        'M': '1 –º–µ—Å—è—Ü'
    };
    return map[tf] || tf;
}

static formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
    return num.toFixed(2);
}

// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
document.addEventListener('DOMContentLoaded', function() {
    ThemeManager.init();
    UI.init();

    const themeIcon = document.querySelector('.theme-toggle-btn i');
    if (themeIcon) {
        themeIcon.className = AppState.currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }
});

</script>

<style>
.trend-info, .momentum-info, .volume-info {
    padding: 15px;
}

.trend-value, .volume-status {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.trend-value.–±—ã—á–∏–π { color: var(--accent-success); }
.trend-value.–º–µ–¥–≤–µ–∂–∏–π { color: var(--accent-error); }
.trend-value.–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π { color: var(--accent-warning); }

.trend-strength, .volume-impact {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.trend-details, .volume-details {
    font-size: 14px;
    line-height: 1.4;
}

.momentum-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding: 8px;
    background: var(--bg-secondary);
    border-radius: 6px;
}

.momentum-item .label {
    font-weight: 500;
}

.momentum-item .value {
    font-weight: bold;
}

.momentum-item .value.overbought { color: var(--accent-error); }
.momentum-item .value.oversold { color: var(--accent-success); }
.momentum-item .value.neutral { color: var(--accent-warning); }
.momentum-item .value.–±—ã—á–∏–π { color: var(--accent-success); }
.momentum-item .value.–º–µ–¥–≤–µ–∂–∏–π { color: var(--accent-error); }
.momentum-item .value.–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π { color: var(--accent-warning); }

.momentum-item .signal {
    font-size: 12px;
    color: var(--text-secondary);
}

.momentum-summary {
    margin-top: 15px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 6px;
    font-size: 14px;
    line-height: 1.4;
}

.volume-status.–≤—ã—Å–æ–∫–∏–π-–æ–±—ä–µ–º { color: var(--accent-success); }
.volume-status.–Ω–∏–∑–∫–∏–π-–æ–±—ä–µ–º { color: var(--accent-error); }
.volume-status.–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π-–æ–±—ä–µ–º { color: var(--accent-warning); }

.loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: var(--text-secondary);
}

.loading-spinner {
    width: 30px;
    height: 30px;
    border: 2px solid var(--border-color);
    border-top: 2px solid var(--accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
}

.empty-state small {
    display: block;
    margin-top: 8px;
    font-size: 12px;
    opacity: 0.7;
}

.error-state {
    text-align: center;
    padding: 30px;
    color: var(--accent-error);
}

.error-state i {
    font-size: 24px;
    margin-bottom: 10px;
}
    /* –î–æ–±–∞–≤–∏—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ */
.price-table {
    width: 100%;
    border-collapse: collapse;
}

.price-table th {
    background: var(--bg-secondary);
    padding: 10px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--border-color);
}

.price-table td {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border-color);
}

.price-table tr:last-child td {
    border-bottom: none;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    background: var(--bg-secondary);
    border-radius: 6px;
}

.stat-item span:first-child {
    font-weight: 500;
    color: var(--text-secondary);
}

.stat-item span:last-child {
    font-weight: 600;
}

.positive { color: var(--accent-success); }
.negative { color: var(--accent-error); }
</style>
<script src="{{ url_for('static', filename='js/i18n.js') }}"></script>

</html>