<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã - CryptoAnalyst Pro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tradingview.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/inline-styles.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìà</text></svg>">

</head>
{%include '_lang_header.html'%}

    <div class="container">
        <header>
            {% include '_header.html' %}
        </header>

        <main>
            <!-- Page Header -->
            <div class="page-header">
                <div class="header-content">
                    <h2 id="symbol-header">–ê–Ω–∞–ª–∏–∑ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã</h2>
                    <div class="header-actions">
                        <span class="update-time" id="update-time">
                            <i class="fas fa-clock"></i> –û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="update-timestamp">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </span>
                        <button class="btn btn-primary" id="refresh-analysis">
                            <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>

            <!-- Price Header -->
            <section class="price-header">
                <div class="price-info">
                    <h3 id="current-symbol">{{ symbol }}</h3>
                    <div class="price-large" id="current-price">${{ "%.2f"|format(current_price) if current_price else "0.00" }}</div>
                    <div class="price-change {% if price_change >= 0 %}positive{% else %}negative{% endif %}"
                         id="price-change">
                        <i class="fas fa-arrow-{% if price_change >= 0 %}up{% else %}down{% endif %}"></i>
                        {{ "%.2f"|format(price_change|abs) }}%
                    </div>
                </div>
            </section>

            <!-- TradingView Chart -->
            <section class="chart-section">
                <div class="tradingview-widget-container">
                    <div id="tradingview-chart"></div>
                    <div class="tradingview-widget-copyright">
                        <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                            <span class="blue-text">Track –≤—Å–µ —Ä—ã–Ω–∫–∏ –Ω–∞ TradingView</span>
                        </a>
                    </div>
                </div>

                <!-- Timeframe Controls -->
                <div class="timeframe-controls">
                    <h4><i class="fas fa-chart-line"></i> –¢–∞–π–º—Ñ—Ä–µ–π–º –∞–Ω–∞–ª–∏–∑–∞</h4>
                    <div class="timeframe-buttons">
                        <button class="btn" data-tf="1">1M</button>
                        <button class="btn" data-tf="5">5M</button>
                        <button class="btn" data-tf="15">15M</button>
                        <button class="btn" data-tf="30">30M</button>
                        <button class="btn active" data-tf="60">1H</button>
                        <button class="btn" data-tf="240">4H</button>
                        <button class="btn" data-tf="D">1D</button>
                        <button class="btn" data-tf="W">1W</button>
                    </div>
                </div>
            </section>

            <!-- Auto Refresh Section -->
            <section class="auto-refresh-section">
                <div class="refresh-controls">
                    <h4><i class="fas fa-sync-alt"></i> –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h4>
                    <div class="refresh-status">
                        <span class="live-indicator"></span>
                        <span>–°–ª–µ–¥—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑: <span id="countdown">15</span> —Å–µ–∫</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <button class="refresh-btn" id="toggle-refresh">
                        <i class="fas fa-pause"></i> –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    </button>
                </div>
            </section>

            <!-- Analysis Results -->
            <section class="analysis-results">
                <h3><i class="fas fa-chart-bar"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>

                <div class="analysis-grid">
                    <!-- Recommendation Card -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4>–¢–æ—Ä–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</h4>
                            <span class="live-indicator"></span>
                        </div>
                        <div class="recommendation" id="recommendation">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...</p>
                            </div>
                        </div>
                        <div class="confidence-score">
                            <div class="score-label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞:</div>
                            <div class="score-bar">
                                <div class="score-fill" id="confidence-fill"></div>
                            </div>
                            <span class="score-value" id="confidence-value">0%</span>
                        </div>
                    </div>

                    <!-- Trend Analysis -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4>–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–∞</h4>
                            <i class="fas fa-wave-square"></i>
                        </div>
                        <div class="analysis-content" id="trend-analysis">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Momentum Analysis -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4>–ú–æ–º–µ–Ω—Ç—É–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</h4>
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div class="analysis-content" id="momentum-analysis">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Volume Analysis -->
                    <div class="analysis-card">
                        <div class="card-header">
                            <h4>–ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–º–∞</h4>
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="analysis-content" id="volume-analysis">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Technical Indicators -->
            <section class="indicators-section">
                <h3><i class="fas fa-sliders-h"></i> –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</h3>

                <div class="indicators-grid">
                    <div class="indicator-card">
                        <h4>RSI (14 –ø–µ—Ä–∏–æ–¥–æ–≤)</h4>
                        <div class="indicator-value" id="rsi-value">-</div>
                        <div class="indicator-bar">
                            <div class="indicator-fill" id="rsi-bar"></div>
                        </div>
                        <div class="indicator-signal" id="rsi-signal">-</div>
                    </div>

                    <div class="indicator-card">
                        <h4>MACD</h4>
                        <div class="indicator-value" id="macd-value">-</div>
                        <div class="indicator-signal" id="macd-signal">-</div>
                        <div class="indicator-hint" id="macd-hint">-</div>
                    </div>

                    <div class="indicator-card">
                        <h4>Bollinger Bands</h4>
                        <div class="indicator-value" id="bb-value">-</div>
                        <div class="indicator-signal" id="bb-signal">-</div>
                        <div class="indicator-hint" id="bb-hint">-</div>
                    </div>

                    <div class="indicator-card">
                        <h4>–°—Ç–æ—Ö–∞—Å—Ç–∏–∫</h4>
                        <div class="indicator-value" id="stoch-value">-</div>
                        <div class="indicator-signal" id="stoch-signal">-</div>
                        <div class="indicator-hint" id="stoch-hint">-</div>
                    </div>
                </div>
            </section>

            <!-- Pattern Detection -->
            <section class="patterns-section">
                <h3><i class="fas fa-shapes"></i> –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</h3>

                <div class="patterns-grid" id="patterns-container">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>–ü–æ–∏—Å–∫ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤...</p>
                    </div>
                </div>
            </section>

            <!-- Profit Potential -->
            <section class="profit-section">
                <h3><i class="fas fa-chart-line"></i> –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø—Ä–∏–±—ã–ª–∏</h3>

                <div class="profit-card">
                    <div class="profit-header">
                        <div class="profit-value" id="profit-value">0%</div>
                        <div class="profit-confidence" id="profit-confidence">–ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
                    </div>

                    <div class="profit-breakdown">
                        <div class="profit-item">
                            <span>–†–∏—Å–∫-–ø—Ä–æ—Ñ–∏—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ:</span>
                            <span id="risk-reward">1:0</span>
                        </div>
                        <div class="profit-item">
                            <span>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ç–æ–ø-–ª–æ—Å—Å:</span>
                            <span id="stop-loss">-</span>
                        </div>
                        <div class="profit-item">
                            <span>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Ü–µ–ª—å:</span>
                            <span id="take-profit">-</span>
                        </div>
                        <div class="profit-item">
                            <span>–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å —Ä—ã–Ω–∫–∞:</span>
                            <span id="volatility">-</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Multi-Timeframe Analysis -->
            <section class="multi-timeframe-section">
                <h3><i class="fas fa-layer-group"></i> –ê–Ω–∞–ª–∏–∑ –ø–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞–º</h3>

                <div class="timeframe-cards">
                    <div class="timeframe-card">
                        <h4>1H</h4>
                        <div class="tf-signal" id="tf-1h">-</div>
                        <div class="tf-confidence" id="tf-1h-conf">-</div>
                    </div>

                    <div class="timeframe-card">
                        <h4>4H</h4>
                        <div class="tf-signal" id="tf-4h">-</div>
                        <div class="tf-confidence" id="tf-4h-conf">-</div>
                    </div>

                    <div class="timeframe-card">
                        <h4>1D</h4>
                        <div class="tf-signal" id="tf-1d">-</div>
                        <div class="tf-confidence" id="tf-1d-conf">-</div>
                    </div>

                    <div class="timeframe-card">
                        <h4>1W</h4>
                        <div class="tf-signal" id="tf-1w">-</div>
                        <div class="tf-confidence" id="tf-1w-conf">-</div>
                    </div>
                </div>
            </section>

            <!-- Risk Calculator -->
            <section class="risk-calculator-section">
                <h3><i class="fas fa-calculator"></i> –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∏—Å–∫–∞</h3>

                <div class="calculator-grid">
                    <div class="calculator-card">
                        <h4>–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏</h4>
                        <div class="calculator-form">
                            <label>–†–∞–∑–º–µ—Ä –¥–µ–ø–æ–∑–∏—Ç–∞ ($):</label>
                            <input type="number" id="deposit-size" value="1000" min="10" step="10">

                            <label>–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (%):</label>
                            <input type="range" id="risk-percent" min="0.5" max="5" step="0.5" value="2">
                            <span id="risk-value">2%</span>

                            <div class="calculator-result">
                                <strong>–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏: <span id="position-size">$0</span></strong>
                            </div>
                        </div>
                    </div>

                    <div class="calculator-card">
                        <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–æ–º</h4>
                        <div class="management-stats">
                            <div class="management-item">
                                <span>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫:</span>
                                <span id="max-loss">$0</span>
                            </div>
                            <div class="management-item">
                                <span>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å:</span>
                                <span id="potential-profit">$0</span>
                            </div>
                            <div class="management-item">
                                <span>–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ R/R:</span>
                                <span id="rr-ratio">1:0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Additional Data -->
            <section class="additional-data-section">
                <h3><i class="fas fa-database"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>

                <div class="data-grid">
    <div class="data-card">
        <h4>–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</h4>
        <div class="price-table">
            <table>
                <thead>
                    <tr>
                        <th>–ü–µ—Ä–∏–æ–¥</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="history-data">
                    <tr><td colspan="3">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="data-card">
        <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä—ã–Ω–∫–∞</h4>
        <div class="stats-grid">
            <div class="stat-item">
                <span>–û–±—ä–µ–º (24—á):</span>
                <span id="volume-24h">-</span>
            </div>
            <div class="stat-item">
                <span>–ú–∞–∫—Å. —Ü–µ–Ω–∞ (24—á):</span>
                <span id="high-24h">-</span>
            </div>
            <div class="stat-item">
                <span>–ú–∏–Ω. —Ü–µ–Ω–∞ (24—á):</span>
                <span id="low-24h">-</span>
            </div>
            <div class="stat-item">
                <span>–ò–∑–º–µ–Ω–µ–Ω–∏–µ (24—á):</span>
                <span id="change-24h">-</span>
            </div>
        </div>
    </div>
</div>
            </section>
        </main>

        <footer class="main-footer">
            <div class="footer-content">
                <p>&copy; 2025 CryptoAnalyst Pro | –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</p>
                <p class="disclaimer">
                    <i class="fas fa-exclamation-triangle"></i>
                    –î–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π. –¢–æ—Ä–≥—É–π—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ, –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã - –≤—ã—Å–æ–∫–æ—Ä–∏—Å–∫–æ–≤—ã–µ –∞–∫—Ç–∏–≤—ã.
                </p>
            </div>
        </footer>
    </div>

    <!-- TradingView Widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <!-- TradingView Widget -->
    <!-- DUP REMOVED: tv.js -->

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º JS —Ñ–∞–π–ª—ã -->
    <script src="{{ url_for('static', filename='js/tradingview-loader.js') }}"></script>
    <script src="{{ url_for('static', filename='js/analysis-core.js') }}"></script>

    <script >
        // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π inline —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        document.addEventListener('DOMContentLoaded', function() {
            // –ë–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã
            const savedTheme = localStorage.getItem('cryptoanalyst_theme');
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            const theme = savedTheme || systemTheme;

            document.documentElement.setAttribute('data-theme', theme);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ —Ç–µ–º—ã
            const themeIcon = document.querySelector('#theme-toggle i');
            if (themeIcon) {
                themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            if (typeof AnalysisCore !== 'undefined') {
                AnalysisCore.init();
            }
        });
    </script>

    <script>
        // ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
        const AppConfig = {
            refreshInterval: 15000,
            apiTimeout: 10000,
            themeKey: 'cryptoanalyst_theme'
        };

        // ===== –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï =====
        let AppState = {
            currentSymbol: '',
            currentTimeframe: '60',
            currentTheme: 'dark',
            autoRefresh: true,
            refreshTimer: null,
            countdown: 15,
            tradingViewWidget: null,
            currentData: null
        };

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ï–ú–û–ô =====
        class ThemeManager {
            static init() {
                this.loadTheme();
                this.setupEventListeners();
            }

            static loadTheme() {
                const savedTheme = localStorage.getItem(AppConfig.themeKey);
                const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                AppState.currentTheme = savedTheme || systemTheme;

                document.documentElement.setAttribute('data-theme', AppState.currentTheme);
                this.updateThemeIcon();
            }

            static toggleTheme() {
                AppState.currentTheme = AppState.currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', AppState.currentTheme);
                localStorage.setItem(AppConfig.themeKey, AppState.currentTheme);

                this.updateThemeIcon();
            }

            static updateThemeIcon() {
                const themeIcon = document.querySelector('#theme-toggle i');
                if (themeIcon) {
                    themeIcon.className = AppState.currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                }
            }

            static setupEventListeners() {
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => this.toggleTheme());
                }
            }
        }

        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–ú–ò =====
        class DataManager {
            static async loadAnalysisData(symbol, timeframe) {
              try {
                // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 30 —Å–µ–∫—É–Ω–¥
                const cacheKey = `analysis_${symbol}_${timeframe}`;
                const cachedData = sessionStorage.getItem(cacheKey);
                const cachedTime = sessionStorage.getItem(`${cacheKey}_time`);

                if (cachedData && cachedTime && (Date.now() - cachedTime < 30000)) {
                  return JSON.parse(cachedData);
                }

                // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                await new Promise(resolve => setTimeout(resolve, 1000));

                const response = await fetch(`/api/analyze/${symbol}?timeframe=${timeframe}`);

                if (response.status === 429) {
                  // –ï—Å–ª–∏ –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω, –∂–¥–µ–º 5 —Å–µ–∫—É–Ω–¥
                  await new Promise(resolve => setTimeout(resolve, 5000));
                  return this.loadAnalysisData(symbol, timeframe);
                }

                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                  throw new Error(data.error || 'Unknown error');
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                sessionStorage.setItem(cacheKey, JSON.stringify(data));
                sessionStorage.setItem(`${cacheKey}_time`, Date.now());

                return data;
              } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞:', error);

                // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                return this.generateDemoData(symbol, timeframe);
              }
            }

            static generateDemoData(symbol, timeframe) {
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                const price = 45000 + Math.random() * 5000;
                const change = (Math.random() * 10 - 5);
                const score = 30 + Math.random() * 60;

                let recommendation, confidence;
                if (score > 70) {
                    recommendation = "–ü–û–ö–£–ü–ê–¢–¨";
                    confidence = "–í—ã—Å–æ–∫–∞—è";
                } else if (score < 40) {
                    recommendation = "–ü–†–û–î–ê–í–ê–¢–¨";
                    confidence = "–°—Ä–µ–¥–Ω—è—è";
                } else {
                    recommendation = "–ù–ï–ô–¢–†–ê–õ–¨–ù–û";
                    confidence = "–ù–∏–∑–∫–∞—è";
                }

                return {
                    success: true,
                    symbol: symbol,
                    timeframe: timeframe,
                    analysis: {
                        price: price,
                        price_change: change,
                        recommendation: recommendation,
                        score: score,
                        confidence: confidence,
                        technical_indicators: {
                            rsi: (30 + Math.random() * 40).toFixed(2),
                            macd: {
                                value: (Math.random() * 0.1 - 0.05).toFixed(6),
                                signal: Math.random() > 0.5 ? "–ë—ã—á–∏–π" : "–ú–µ–¥–≤–µ–∂–∏–π"
                            },
                            bollinger_bands: {
                                position: Math.random() > 0.5 ? "–í–µ—Ä—Ö–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∞" : "–ù–∏–∂–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∞"
                            }
                        }
                    },
                    patterns: [
                        {
                            name: "–î–≤–æ–π–Ω–æ–µ –¥–Ω–æ",
                            type: "–†–∞–∑–≤–æ—Ä–æ—Ç–Ω—ã–π",
                            confidence: "–í—ã—Å–æ–∫–∞—è",
                            description: "–î–≤–∞ –º–∏–Ω–∏–º—É–º–∞ –Ω–∞ –æ–¥–Ω–æ–º —É—Ä–æ–≤–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
                            easter_egg: "–û–±—ä–µ–º –æ–±—ã—á–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –≤—Ç–æ—Ä–æ–º –¥–Ω–µ"
                        },
                        {
                            name: "–ë—ã—á—å–µ –ø–æ–≥–ª–æ—â–µ–Ω–∏–µ",
                            type: "–†–∞–∑–≤–æ—Ä–æ—Ç–Ω—ã–π",
                            confidence: "–°—Ä–µ–¥–Ω—è—è",
                            description: "–ë—ã—á—å—è —Å–≤–µ—á–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–ª–æ—â–∞–µ—Ç –º–µ–¥–≤–µ–∂—å—é",
                            easter_egg: "–°–∏–ª—å–Ω—ã–π —Ä–∞–∑–≤–æ—Ä–æ—Ç–Ω—ã–π —Å–∏–≥–Ω–∞–ª –ø—Ä–∏ –æ–±—ä–µ–º–µ"
                        }
                    ],
                    profit_potential: {
                        potential_profit: (5 + Math.random() * 10).toFixed(1) + "%",
                        confidence: confidence,
                        risk_reward_ratio: "1:" + (2 + Math.random() * 2).toFixed(1),
                        stop_loss: (price * 0.97).toFixed(2),
                        take_profit: (price * 1.05).toFixed(2),
                        volatility_based: (30 + Math.random() * 40).toFixed(1) + "%"
                    },
                    timestamp: new Date().toISOString()
                };
            }
        }

        // ===== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê =====
        class UI {
            static init() {
            this.parseUrlParams();
            this.setupEventListeners();
            this.initTradingView();
            this.startAutoRefresh();

              // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º TradingView —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            setTimeout(() => {
                this.initTradingView();
            }, 1000);

              // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å 429
            setTimeout(() => {
                this.refreshData();
            }, 2000);

            // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–æ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            const initialData = {
                symbol: '{{ symbol }}',
                timeframe: '{{ timeframe }}',
                analysis: {{ analysis|tojson }},
                patterns: {{ patterns|tojson }},
                profit_potential: {{ profit_potential|tojson }},
                current_price: {{ current_price }},
                price_change: {{ price_change }}
            };

            this.updateUI(initialData);
        }

            static parseUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                AppState.currentSymbol = urlParams.get('symbol') || 'symbol';
                AppState.currentTimeframe = urlParams.get('timeframe') || '60';

                document.getElementById('symbol-header').textContent = `–ê–Ω–∞–ª–∏–∑ ${AppState.currentSymbol}`;
                document.getElementById('current-symbol').textContent = AppState.currentSymbol;
            }

            static setupEventListeners() {
                // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                document.getElementById('refresh-analysis').addEventListener('click', () => {
                    this.refreshData();
                });

                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                document.getElementById('toggle-refresh').addEventListener('click', () => {
                    AppState.autoRefresh = !AppState.autoRefresh;
                    this.toggleAutoRefresh();
                });

                // –ö–Ω–æ–ø–∫–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
                document.querySelectorAll('.timeframe-buttons .btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.timeframe-buttons .btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        AppState.currentTimeframe = btn.dataset.tf;
                        this.refreshData();
                    });
                });

                // –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∏—Å–∫–∞
                const riskSlider = document.getElementById('risk-percent');
                const riskValue = document.getElementById('risk-value');
                const depositInput = document.getElementById('deposit-size');

                riskSlider.addEventListener('input', () => {
                    riskValue.textContent = `${riskSlider.value}%`;
                    this.updateRiskCalculator();
                });

                depositInput.addEventListener('input', () => {
                    this.updateRiskCalculator();
                });
            }

            static async refreshData() {
              try {
                UI.showLoadingState();

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                await new Promise(resolve => setTimeout(resolve, 500));

                const data = await DataManager.loadAnalysisData(
                  AppState.currentSymbol,
                  AppState.currentTimeframe
                );

                this.updateUI(data);
              } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
                UI.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
              }
            }

            static updateUI(data) {
                if (!data) return;

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏–∑ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                this.updatePriceData({
                    analysis: {
                        price: data.current_price,
                        price_change: data.price_change
                    }
                });

                // –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                this.updateRecommendation(data.analysis);
                this.updateIndicators(data.analysis);
                this.updatePatterns(data.patterns);
                this.updateProfitPotential(data.profit_potential);

                document.getElementById('update-timestamp').textContent = new Date().toLocaleTimeString();
            }

            static updatePriceData(data) {
                if (!data) return;

                const priceElement = document.getElementById('current-price');
                const changeElement = document.getElementById('price-change');
                const changeIcon = changeElement?.querySelector('i');

                if (!priceElement || !changeElement) {
                    console.error('Price elements not found');
                    return;
                }

                const price = data.analysis?.price || 0;
                const change = data.analysis?.price_change || 0;

                priceElement.textContent = `$${this.formatPrice(price)}`;

                changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                changeElement.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;

                if (changeIcon) {
                    changeIcon.className = change >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
                }
            }

            static updateRecommendation(analysis) {
                const recommendationElement = document.getElementById('recommendation');
                const confidenceElement = document.getElementById('confidence-value');
                const confidenceFill = document.getElementById('confidence-fill');

                if (!analysis) {
                    recommendationElement.innerHTML = `
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>–î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</p>
                        </div>
                    `;
                    return;
                }

                const recommendation = analysis.recommendation || '–ù–ï–ô–¢–†–ê–õ–¨–ù–û';
                const score = analysis.score || 50;
                const confidence = analysis.confidence || '–ù–∏–∑–∫–∞—è';

                recommendationElement.innerHTML = `
                    <div class="recommendation ${recommendation.toLowerCase()}">
                        ${recommendation}
                    </div>
                    <div class="recommendation-explanation">
                        ${this.getRecommendationExplanation(recommendation, analysis)}
                    </div>
                `;

                confidenceElement.textContent = `${score}%`;
                confidenceFill.style.width = `${score}%`;
                confidenceFill.style.background = this.getConfidenceColor(score);
            }

            static updateIndicators(analysis) {
                if (!analysis || !analysis.technical_indicators) return;

                const indicators = analysis.technical_indicators;

                // RSI
                if (indicators.rsi) {
                    document.getElementById('rsi-value').textContent = indicators.rsi;
                    document.getElementById('rsi-bar').style.width = `${indicators.rsi}%`;
                    document.getElementById('rsi-bar').style.background = this.getRsiColor(indicators.rsi);
                    document.getElementById('rsi-signal').textContent = this.getRsiSignal(indicators.rsi);
                }

                // MACD
                if (indicators.macd) {
                    const macdValue = indicators.macd.value || 0;
                    const macdSignal = indicators.macd.signal || '';

                    document.getElementById('macd-value').textContent = macdValue.toFixed(6);
                    document.getElementById('macd-signal').textContent = macdSignal;
                    document.getElementById('macd-hint').textContent = this.getMacdHint(macdValue, macdSignal);
                }

                // Bollinger Bands
                if (indicators.bollinger_bands) {
                    const position = indicators.bollinger_bands.position || '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';

                    document.getElementById('bb-value').textContent = position;
                    document.getElementById('bb-signal').textContent = this.getBollingerSignal(position);
                    document.getElementById('bb-hint').textContent = this.getBollingerHint(position);
                }
            }

            static updatePatterns(patterns) {
                const container = document.getElementById('patterns-container');

                if (!patterns || patterns.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <p>–ü–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = patterns.map(pattern => `
                    <div class="pattern-card">
                        <div class="pattern-header">
                            <h4>${pattern.name}</h4>
                            <span class="confidence-badge ${pattern.confidence.toLowerCase()}">
                                ${pattern.confidence}
                            </span>
                        </div>
                        <div class="pattern-type">–¢–∏–ø: ${pattern.type}</div>
                        <p class="pattern-description">${pattern.description}</p>
                        <div class="pattern-hint">${pattern.easter_egg}</div>
                    </div>
                `).join('');
            }

            static updateProfitPotential(profitData) {
                if (!profitData) return;

                document.getElementById('profit-value').textContent = profitData.potential_profit || '0%';
                document.getElementById('profit-confidence').textContent = profitData.confidence || '–ù–∏–∑–∫–∞—è';
                document.getElementById('risk-reward').textContent = profitData.risk_reward_ratio || '1:0';
                document.getElementById('stop-loss').textContent = profitData.stop_loss || '-';
                document.getElementById('take-profit').textContent = profitData.take_profit || '-';
                document.getElementById('volatility').textContent = profitData.volatility_based || '-';
            }

            static initTradingView() {
              try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ TradingView
                if (typeof TradingView === 'undefined') {
                  console.warn('TradingView widget not loaded - library not found');
                  this.showTradingViewFallback();
                  return null;
                }

                const exchange = AppState.exchange || 'BINANCE';
                const symbol = `${exchange}:${AppState.currentSymbol}`;
                const interval = this.getTradingViewInterval(AppState.currentTimeframe || '60');
                const theme = (AppState.currentTheme === 'dark') ? 'dark' : 'light';

                console.log('Initializing TradingView with:', { symbol, interval, theme });

                // –°–æ–∑–¥–∞–µ–º –≤–∏–¥–∂–µ—Ç
                const widget = new TradingView.widget({
                  symbol: symbol,
                  interval: interval,
                  container_id: 'tradingview-chart',
                  autosize: true,
                  locale: AppState.lang || 'ru',
                  timezone: 'Europe/Moscow',
                  theme: theme,
                  style: '1',
                  toolbar_bg: (theme === 'dark') ? '#0b0f16' : '#f1f3f6',
                  enable_publishing: false,
                  allow_symbol_change: true,
                  hide_top_toolbar: false,
                  hide_side_toolbar: false,
                  hide_legend: false,
                  save_image: false,
                  studies: [
                    'RSI@tv-basicstudies',
                    'MACD@tv-basicstudies',
                    'StochasticRSI@tv-basicstudies',
                    'BB@tv-basicstudies',
                    'Volume@tv-basicstudies'
                  ],
                  drawings_access: {
                    type: 'all',
                    tools: [
                      { name: 'Regression Trend' },
                      { name: 'Trend Angle' },
                      { name: 'Trend Line' },
                      { name: 'Horizontal Line' },
                      { name: 'Vertical Line' },
                      { name: 'Line' },
                      { name: 'Arrow' }
                    ]
                  },
                  overrides: {
                    "paneProperties.background": theme === 'dark' ? "#131722" : "#FFFFFF",
                    "paneProperties.vertGridProperties.color": theme === 'dark' ? "#363c4e" : "#E0E3EB",
                    "paneProperties.horzGridProperties.color": theme === 'dark' ? "#363c4e" : "#E0E3EB",
                    "mainSeriesProperties.candleStyle.upColor": theme === 'dark' ? "#26a69a" : "#089981",
                    "mainSeriesProperties.candleStyle.downColor": theme === 'dark' ? "#ef5350" : "#f23645",
                    "mainSeriesProperties.candleStyle.wickUpColor": theme === 'dark' ? "#26a69a" : "#089981",
                    "mainSeriesProperties.candleStyle.wickDownColor": theme === 'dark' ? "#ef5350" : "#f23645"
                  },
                  loading_screen: {
                    backgroundColor: theme === 'dark' ? "#131722" : "#FFFFFF"
                  },
                  disabled_features: [
                    "header_widget_dom_node",
                    "header_compare",
                    "header_interval_dialog_button",
                    "show_interval_dialog_on_key_press"
                  ],
                  enabled_features: [
                    "study_templates",
                    "move_logo_to_main_pane",
                    "side_toolbar_in_fullscreen_mode"
                  ]
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≥—Ä–∞—Ñ–∏–∫–∞
                widget.onChartReady(() => {
                  console.log('TradingView chart ready');
                  AppState.tradingViewWidget = widget;

                  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≥—Ä–∞—Ñ–∏–∫
                  const chart = widget.chart();

                  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–∞
                  chart.onSymbolChanged().subscribe(
                    null,
                    (symbolName) => {
                      console.log('Symbol changed to:', symbolName);
                      const symbolParts = symbolName.split(':');
                      if (symbolParts.length > 1 && symbolParts[1] !== AppState.currentSymbol) {
                        AppState.currentSymbol = symbolParts[1];
                        this.handleSymbolChange(symbolParts[1]);
                      }
                    }
                  );

                  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
                  chart.onIntervalChanged().subscribe(
                    null,
                    (newInterval) => {
                      console.log('Interval changed to:', newInterval);
                      const mappedInterval = this.mapFromTradingViewInterval(newInterval);
                      if (mappedInterval && mappedInterval !== AppState.currentTimeframe) {
                        AppState.currentTimeframe = mappedInterval;
                        this.handleTimeframeChange(mappedInterval);
                      }
                    }
                  );

                  // –î–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑—É–µ–º —Å–æ–±—ã—Ç–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                  this.dispatchEvent('tradingview:ready', { widget, chart });
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
                widget.onError((error) => {
                  console.error('TradingView widget error:', error);
                  this.showTradingViewFallback();
                });

                return widget;

              } catch (error) {
                console.error('TradingView initialization error:', error);
                this.showTradingViewFallback();
                return null;
              }
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏
            static getTradingViewInterval(interval) {
              const intervalMap = {
                '1': '1',
                '5': '5',
                '15': '15',
                '30': '30',
                '60': '60',
                '240': '240',
                'D': '1D',
                'W': '1W',
                'M': '1M'
              };
              return intervalMap[interval] || '60';
            }

            static mapFromTradingViewInterval(tvInterval) {
              const reverseMap = {
                '1': '1',
                '5': '5',
                '15': '15',
                '30': '30',
                '60': '60',
                '240': '240',
                '1D': 'D',
                '1W': 'W',
                '1M': 'M'
              };
              return reverseMap[tvInterval] || '60';
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            static handleSymbolChange(newSymbol) {
              console.log('Handling symbol change to:', newSymbol);
              // –û–±–Ω–æ–≤–ª—è–µ–º URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
              const newUrl = `${window.location.pathname}?symbol=${newSymbol}&timeframe=${AppState.currentTimeframe}`;
              window.history.replaceState(null, '', newUrl);

              // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
              document.getElementById('current-symbol').textContent = newSymbol;
              document.getElementById('symbol-header').textContent = `–ê–Ω–∞–ª–∏–∑ ${newSymbol}`;

              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
              this.refreshData();
            }

            static handleTimeframeChange(newTimeframe) {
              console.log('Handling timeframe change to:', newTimeframe);
              // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
              document.querySelectorAll('.timeframe-buttons .btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tf === newTimeframe) {
                  btn.classList.add('active');
                }
              });

              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
              this.refreshData();
            }

            // Fallback –¥–ª—è —Å–ª—É—á–∞—è –∫–æ–≥–¥–∞ TradingView –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
            static showTradingViewFallback() {
              const chartContainer = document.getElementById('tradingview-chart');
              if (chartContainer) {
                chartContainer.innerHTML = `
                  <div class="chart-fallback">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>–ì—Ä–∞—Ñ–∏–∫ TradingView –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h4>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É</p>
                    <button onclick="UI.initTradingView()" class="btn btn-primary">
                      <i class="fas fa-sync-alt"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                  </div>
                `;
              }
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π
            static dispatchEvent(eventName, detail = {}) {
              if (typeof window !== 'undefined') {
                window.dispatchEvent(new CustomEvent(eventName, { detail }));
              }
            }

            static startAutoRefresh() {
                if (AppState.refreshTimer) {
                    clearInterval(AppState.refreshTimer);
                }

                AppState.refreshTimer = setInterval(() => {
                    if (AppState.autoRefresh) {
                        if (AppState.countdown > 0) {
                            AppState.countdown--;
                            document.getElementById('countdown').textContent = AppState.countdown;
                            document.getElementById('progress-fill').style.width =
                                `${(100 - (AppState.countdown / 15 * 100))}%`;
                        } else {
                            AppState.countdown = 15;
                            this.refreshData();
                        }
                    }
                }, 1000);
            }

            static toggleAutoRefresh() {
                const toggleBtn = document.getElementById('toggle-refresh');
                const icon = toggleBtn.querySelector('i');

                if (AppState.autoRefresh) {
                    toggleBtn.innerHTML = '<i class="fas fa-play"></i> –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
                    toggleBtn.style.background = 'var(--accent-success)';
                } else {
                    toggleBtn.innerHTML = '<i class="fas fa-pause"></i> –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
                    toggleBtn.style.background = 'var(--accent-warning)';
                }
            }

            static showLoadingState() {
                document.querySelectorAll('.analysis-content, #recommendation, #patterns-container')
                    .forEach(el => {
                        el.innerHTML = `
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                            </div>
                        `;
                    });
            }

            static showError(message) {
                const recommendationElement = document.getElementById('recommendation');
                recommendationElement.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>${message}</p>
                        <button class="btn btn-primary" onclick="UI.refreshData()">
                            <i class="fas fa-sync-alt"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </button>
                    </div>
                `;
            }

            static formatPrice(price) {
                if (price >= 1000) return price.toFixed(0);
                if (price >= 1) return price.toFixed(2);
                if (price >= 0.01) return price.toFixed(4);
                return price.toFixed(6);
            }

            static getRecommendationExplanation(recommendation, analysis) {
                const explanations = {
                    '–ü–û–ö–£–ü–ê–¢–¨': '–°–∏–ª—å–Ω—ã–µ –±—ã—á—å–∏ —Å–∏–≥–Ω–∞–ª—ã. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–∫—É–ø–∫—É.',
                    '–ü–†–û–î–ê–í–ê–¢–¨': '–°–∏–ª—å–Ω—ã–µ –º–µ–¥–≤–µ–∂—å–∏ —Å–∏–≥–Ω–∞–ª—ã. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–¥–∞–∂—É.',
                    '–ù–ï–ô–¢–†–ê–õ–¨–ù–û': '–°–∏–≥–Ω–∞–ª—ã –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–∂–∏–¥–∞–Ω–∏–µ.'
                };

                return explanations[recommendation] || '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω.';
            }

            static getConfidenceColor(score) {
                if (score >= 70) return 'var(--accent-success)';
                if (score >= 50) return 'var(--accent-warning)';
                return 'var(--accent-error)';
            }

            static getRsiColor(value) {
                if (value > 70) return 'var(--accent-error)';
                if (value < 30) return 'var(--accent-success)';
                return 'var(--accent-warning)';
            }

            static getRsiSignal(value) {
                if (value > 70) return '–ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å';
                if (value < 30) return '–ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å';
                return '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';
            }

            static getMacdHint(value, signal) {
                if (value > 0 && signal === '–ë—ã—á–∏–π') return '–°–∏–ª—å–Ω—ã–π –±—ã—á–∏–π —Å–∏–≥–Ω–∞–ª';
                if (value < 0 && signal === '–ú–µ–¥–≤–µ–∂–∏–π') return '–°–∏–ª—å–Ω—ã–π –º–µ–¥–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª';
                return '–°–∏–≥–Ω–∞–ª –Ω–µ—è—Å–µ–Ω';
            }

            static getBollingerSignal(position) {
                if (position.includes('–ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å')) return '–ú–µ–¥–≤–µ–∂–∏–π';
                if (position.includes('–ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å')) return '–ë—ã—á–∏–π';
                return '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π';
            }

            static getBollingerHint(position) {
                if (position.includes('–ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å')) return '–í–æ–∑–º–æ–∂–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –≤–Ω–∏–∑';
                if (position.includes('–ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å')) return '–í–æ–∑–º–æ–∂–µ–Ω –æ—Ç—Å–∫–æ–∫ –≤–≤–µ—Ä—Ö';
                return '–¶–µ–Ω–∞ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ';
            }

            static updateRiskCalculator() {
                const deposit = parseFloat(document.getElementById('deposit-size').value) || 1000;
                const riskPercent = parseFloat(document.getElementById('risk-percent').value) || 2;
                const riskAmount = deposit * (riskPercent / 100);

                if (AppState.currentData && AppState.currentData.analysis) {
                    const price = AppState.currentData.analysis.price;
                    const stopLossPercent = 3; // –ü—Ä–∏–º–µ—Ä: 3% —Å—Ç–æ–ø-–ª–æ—Å—Å
                    const positionSize = riskAmount / (stopLossPercent / 100);

                    document.getElementById('position-size').textContent = `$${positionSize.toFixed(2)}`;
                    document.getElementById('max-loss').textContent = `$${riskAmount.toFixed(2)}`;

                    // –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏
                    const potentialGain = positionSize * 0.05; // 5% –ø—Ä–∏–±—ã–ª—å
                    document.getElementById('potential-profit').textContent = `$${potentialGain.toFixed(2)}`;
                    document.getElementById('rr-ratio').textContent = '1:1.67'; // –ü—Ä–∏–º–µ—Ä
                }
            }
        }

        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
        document.addEventListener('DOMContentLoaded', () => {
            ThemeManager.init();
            UI.init();
        });
    </script>

    <!-- –í –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ analysis.html, –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º —Ç–µ–≥–æ–º body -->
    <!-- DUP REMOVED: tradingview-loader.js -->
    <!-- DUP REMOVED: analysis-core.js -->
    <script >
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã
            const savedTheme = localStorage.getItem('cryptoanalyst_theme');
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            const theme = savedTheme || systemTheme;

            document.documentElement.setAttribute('data-theme', theme);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ —Ç–µ–º—ã
            const themeIcon = document.querySelector('#theme-toggle i');
            if (themeIcon) {
                themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('cryptoanalyst_theme', newTheme);

                    const themeIcon = document.querySelector('#theme-toggle i');
                    if (themeIcon) {
                        themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                    }

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ TradingView –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–º—ã
                    if (AnalysisCore.state.tradingViewWidget) {
                        try {
                            AnalysisCore.state.tradingViewWidget.changeTheme(newTheme);
                        } catch (error) {
                            console.warn('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–º—ã TradingView:', error);
                        }
                    }
                });
            }
        });
    </script>
<script src="{{ url_for('static', filename='js/i18n.js') }}"></script>
\1
</html>